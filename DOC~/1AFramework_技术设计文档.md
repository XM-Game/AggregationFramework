# Aggregation Framework (AFramework) 技术设计文档

> 版本：1.0.0  
> 适用 Unity 版本：2022.3 LTS ~ Unity 6.x  
> 最后更新：2025年12月31日

---

## 目录

1. [框架概述](#1-框架概述)
2. [架构设计原则](#2-架构设计原则)
3. [核心架构](#3-核心架构)
4. [模块设计](#4-模块设计)
5. [模块依赖关系](#5-模块依赖关系)
6. [跨版本兼容策略](#6-跨版本兼容策略)
7. [性能优化策略](#7-性能优化策略)
8. [扩展机制](#8-扩展机制)
9. [最佳实践](#9-最佳实践)

---

## 1. 框架概述

### 1.1 框架定位

**Aggregation Framework (AFramework)** 是一个面向 Unity 游戏开发的高性能聚合开发框架。框架以"聚合"为核心理念，将多个高性能、低耦合的功能模块整合为统一的开发体系，为开发者提供标准化、易扩展的游戏开发解决方案。

### 1.2 设计目标

| 目标 | 描述 |
|------|------|
| 高性能 | 零GC分配、SIMD优化、Burst编译、数据局部性优化 |
| 高内聚低耦合 | 模块职责单一、接口清晰、依赖最小化 |
| 事件驱动 | 基于发布-订阅机制的松耦合通信 |
| 数据驱动 | 配置与逻辑分离、运行时动态加载 |
| CQRS | 命令查询职责分离、读写路径优化 |
| 模块化 | 按需引入、独立升级、热插拔支持 |
| 跨版本兼容 | 通过预处理指令支持 Unity 2022.3 LTS 至 Unity 6.x |


### 1.3 模块命名规范

| 功能 | 模块名称 | 命名空间 | 依赖版本 |
|------|----------|----------|----------|
| 对象池 | Pool | AFramework.Pool | - |
| 本地化 | Localization | AFramework.Localization | - |
| ECS实体 | ECS | AFramework.ECS | entities 1.43 |
| 配置模块 | Config | AFramework.Config | - |
| 调试器 | DebugLog | AFramework.DebugLog | - |
| C#扩展库 | CSharpExtension | AFramework.CSharpExtension | - |
| Unity扩展库 | UnityExtension | AFramework.UnityExtension | - |
| 算法优化 | Algorithm | AFramework.Algorithm | - |
| 序列化 | Serialization | AFramework.Serialization | - |
| 依赖注入 | DI | AFramework.DI | - |
| Burst编译 | BurstExtension | AFramework.Burst | Burst 1.8.27 |
| 插件扩展 | Extension | AFramework.Extension | - |
| 内存数据库 | AFrameworkDB | AFramework.DB | - |
| 事件消息系统 | EventSystem | AFramework.EventSystem | - |
| 任务系统 | TaskSystem | AFramework.TaskSystem | - |
| 资源管理系统 | ResourceSystem | AFramework.ResourceSystem | Addressables 1.28 |

### 1.4 核心特性一览

```
┌─────────────────────────────────────────────────────────────────┐
│                    Aggregation Framework                        │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │    Pool     │  │Localization │  │     ECS     │             │
│  │   对象池    │  │   本地化    │  │  实体系统   │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │   Config    │  │  DebugLog   │  │CSharpExtension│            │
│  │  配置模块   │  │   调试器    │  │  C#扩展库   │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │UnityExtension│  │  Algorithm  │  │Serialization│             │
│  │ Unity扩展库 │  │  算法优化   │  │   序列化    │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │     DI      │  │BurstExtension│  │  Extension  │             │
│  │  依赖注入   │  │  Burst编译  │  │  插件扩展   │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │AFrameworkDB │  │ EventSystem │  │ TaskSystem  │             │
│  │ 内存数据库  │  │事件消息系统 │  │  任务系统   │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
│  ┌─────────────────────────────────────────────────┐           │
│  │           ResourceSystem (资源管理系统)          │           │
│  └─────────────────────────────────────────────────┘           │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 架构设计原则

### 2.1 SOLID 原则应用

| 原则 | 框架应用 |
|------|----------|
| **SRP** 单一职责 | 每个模块只负责一个领域，如 Pool 只管对象池，Localization 只管本地化 |
| **OCP** 开闭原则 | 通过接口和抽象类扩展功能，不修改核心代码 |
| **LSP** 里氏替换 | 所有模块实现统一接口，可无缝替换 |
| **ISP** 接口隔离 | 模块对外暴露最小接口集，内部实现隐藏 |
| **DIP** 依赖倒置 | 高层模块依赖抽象接口，通过 DI 容器注入具体实现 |

### 2.2 架构模式选型

```
┌────────────────────────────────────────────────────────────┐
│                      应用层 (Application)                   │
│  ┌──────────────────────────────────────────────────────┐  │
│  │                    游戏业务逻辑                        │  │
│  └──────────────────────────────────────────────────────┘  │
├────────────────────────────────────────────────────────────┤
│                      服务层 (Service)                       │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐             │
│  │ResourceSystem│ │  Config   │ │EventSystem │  ...        │
│  └────────────┘ └────────────┘ └────────────┘             │
├────────────────────────────────────────────────────────────┤
│                      核心层 (Core)                          │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐             │
│  │    DI      │ │ 生命周期   │ │ 模块管理   │             │
│  └────────────┘ └────────────┘ └────────────┘             │
├────────────────────────────────────────────────────────────┤
│                      基础层 (Foundation)                    │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐             │
│  │   Pool     │ │Serialization│ │CSharpExtension│             │
│  └────────────┘ └────────────┘ └────────────┘             │
└────────────────────────────────────────────────────────────┘
```

### 2.3 设计模式应用

| 模式 | 应用场景 |
|------|----------|
| **对象池** | GameObject、组件、纯C#对象的复用 |
| **观察者/发布订阅** | EventSystem 事件消息系统 |
| **命令模式** | TaskSystem 任务系统、CQRS命令端 |
| **策略模式** | Serialization 序列化策略、资源加载策略 |
| **工厂模式** | 实体创建、服务实例化 |
| **外观模式** | 模块对外统一API |
| **装饰器模式** | 功能增强、日志包装 |
| **状态模式** | 任务状态、资源加载状态 |


---

## 3. 核心架构

### 3.1 命名空间规范

```
AFramework                              // 根命名空间
├── AFramework.Pool                     // 对象池
├── AFramework.Localization             // 本地化
├── AFramework.ECS                      // ECS实体系统 (entities 1.43)
├── AFramework.Config                   // 配置模块
├── AFramework.DebugLog                 // 调试器
├── AFramework.CSharpExtension          // C#扩展库
├── AFramework.UnityExtension           // Unity扩展库
├── AFramework.Algorithm                // 算法优化
├── AFramework.Serialization            // 序列化
├── AFramework.DI                       // 依赖注入
├── AFramework.Burst                    // Burst编译扩展 (Burst 1.8.27)
├── AFramework.Extension                // 插件扩展
├── AFramework.DB                       // 内存数据库 (AFrameworkDB)
├── AFramework.EventSystem              // 事件消息系统
├── AFramework.TaskSystem               // 任务系统
├── AFramework.ResourceSystem           // 资源管理系统 (Addressables 1.28)
└── AFramework.Editor                   // 编辑器扩展
```

### 3.2 模块生命周期

```
┌─────────────────────────────────────────────────────────────┐
│                      模块生命周期                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐ │
│   │ 注册    │───▶│ 初始化  │───▶│ 启动    │───▶│ 运行    │ │
│   │Register │    │  Init   │    │  Start  │    │  Tick   │ │
│   └─────────┘    └─────────┘    └─────────┘    └─────────┘ │
│                                                      │      │
│                                                      ▼      │
│   ┌─────────┐    ┌─────────┐    ┌─────────┐              │
│   │ 销毁    │◀───│ 停止    │◀───│ 暂停    │              │
│   │ Dispose │    │  Stop   │    │  Pause  │              │
│   └─────────┘    └─────────┘    └─────────┘              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.3 依赖注入架构 (AFramework.DI)

框架采用分层容器设计：

```
┌─────────────────────────────────────────────────────────────┐
│                     根容器 (Root Container)                  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  全局单例服务：DebugLog、Config、Localization          │  │
│  └───────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│                   场景容器 (Scene Container)                 │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  场景级服务：ResourceSystem、Pool、ECS World           │  │
│  └───────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│                  子容器 (Child Container)                    │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  局部服务：UI面板、游戏实体、临时对象                  │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 3.4 事件驱动架构 (AFramework.EventSystem)

```
┌─────────────────────────────────────────────────────────────┐
│                      事件总线架构                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────┐         ┌─────────────┐         ┌─────────┐   │
│  │ 发布者  │────────▶│  EventBus   │────────▶│ 订阅者  │   │
│  │Publisher│         │  事件总线   │         │Subscriber│   │
│  └─────────┘         └─────────────┘         └─────────┘   │
│                             │                               │
│                             ▼                               │
│                      ┌─────────────┐                        │
│                      │ EventQueue  │                        │
│                      │  事件队列   │                        │
│                      └─────────────┘                        │
│                             │                               │
│              ┌──────────────┼──────────────┐                │
│              ▼              ▼              ▼                │
│        ┌─────────┐   ┌─────────┐   ┌─────────┐             │
│        │同步处理 │   │异步处理 │   │延迟处理 │             │
│        └─────────┘   └─────────┘   └─────────┘             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.5 CQRS 架构

```
┌─────────────────────────────────────────────────────────────┐
│                      CQRS 架构                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────┐     ┌─────────────────────┐       │
│  │     命令端 (Write)   │     │     查询端 (Read)    │       │
│  ├─────────────────────┤     ├─────────────────────┤       │
│  │  ┌───────────────┐  │     │  ┌───────────────┐  │       │
│  │  │ Command       │  │     │  │ Query         │  │       │
│  │  │ Handler       │  │     │  │ Handler       │  │       │
│  │  └───────┬───────┘  │     │  └───────┬───────┘  │       │
│  │          ▼          │     │          ▼          │       │
│  │  ┌───────────────┐  │     │  ┌───────────────┐  │       │
│  │  │ Domain Model  │  │     │  │ Read Model    │  │       │
│  │  │ (Write Store) │  │     │  │ (Query Store) │  │       │
│  │  └───────────────┘  │     │  └───────────────┘  │       │
│  └──────────┬──────────┘     └─────────────────────┘       │
│             │                          ▲                    │
│             │      ┌───────────────┐   │                    │
│             └─────▶│ Event Store   │───┘                    │
│                    │ (同步/投影)    │                        │
│                    └───────────────┘                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```


---

## 4. 模块设计

### 4.1 对象池模块 (Pool)

**命名空间**: `AFramework.Pool`

#### 4.1.1 模块职责

提供高性能的对象复用机制，避免频繁的内存分配和GC压力。

#### 4.1.2 功能特性

| 特性 | 描述 |
|------|------|
| 泛型对象池 | 支持任意类型对象的池化管理 |
| GameObject池 | 专为Unity GameObject优化的对象池 |
| 组件池 | 支持MonoBehaviour组件的池化 |
| 自动扩容 | 池容量不足时自动扩展 |
| 预热机制 | 支持预创建指定数量的对象 |
| 生命周期回调 | OnGet、OnRelease、OnDestroy回调 |
| 容量限制 | 可配置最大容量，防止内存溢出 |
| 统计信息 | 提供池使用率、命中率等统计 |

#### 4.1.3 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                  Pool 模块架构 (AFramework.Pool)             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              IObjectPool<T> 接口                     │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │   │
│  │  │  Get()  │ │Release()│ │ Clear() │ │Prewarm()│   │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│           ┌───────────────┼───────────────┐                 │
│           ▼               ▼               ▼                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ ObjectPool  │ │GameObjectPool│ │ComponentPool│           │
│  │   <T>       │ │             │ │    <T>      │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              PoolManager (池管理器)                   │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │ 池注册表    │ │ 统计监控    │ │ 自动清理    │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 4.1.4 配置项

| 配置项 | 类型 | 默认值 | 描述 |
|--------|------|--------|------|
| InitialCapacity | int | 16 | 初始容量 |
| MaxCapacity | int | 1024 | 最大容量 |
| AutoExpand | bool | true | 是否自动扩容 |
| ExpandStep | int | 16 | 扩容步长 |
| EnableStatistics | bool | false | 是否启用统计 |

---

### 4.2 本地化模块 (Localization)

**命名空间**: `AFramework.Localization`

#### 4.2.1 模块职责

提供多语言支持，包括运行时文本本地化和编辑器界面本地化。

#### 4.2.2 功能特性

| 特性 | 描述 |
|------|------|
| 多语言支持 | 支持任意数量的语言配置 |
| 动态切换 | 运行时无缝切换语言 |
| 参数化文本 | 支持占位符和格式化参数 |
| 复数形式 | 支持不同语言的复数规则 |
| 回退机制 | 缺失翻译时自动回退到默认语言 |
| 编辑器本地化 | 支持Unity编辑器界面本地化 |
| 热重载 | 开发模式下支持翻译热重载 |
| 资源分包 | 支持按语言分包加载 |

#### 4.2.3 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│            Localization 模块架构 (AFramework.Localization)   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              ILocalizationService 接口               │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐            │   │
│  │  │GetText() │ │SetLocale()│ │GetLocale()│            │   │
│  │  └──────────┘ └──────────┘ └──────────┘            │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              LocalizationManager                     │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │ 语言注册表  │ │ 翻译缓存    │ │ 事件通知    │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│           ┌───────────────┼───────────────┐                 │
│           ▼               ▼               ▼                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ CSV加载器   │ │ YAML加载器  │ │ 自定义加载器│           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              编辑器本地化支持                         │   │
│  │  ┌─────────────┐ ┌─────────────┐                    │   │
│  │  │EditorLocale │ │LocalizedAttr│                    │   │
│  │  └─────────────┘ └─────────────┘                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 4.2.4 数据格式

| 格式 | 优点 | 适用场景 |
|------|------|----------|
| CSV | Excel友好、翻译外包 | 大型项目、多人协作 |
| YAML | 结构清晰、易编辑 | 小型项目、快速迭代 |
| Binary | 加载快、体积小 | 发布版本 |


---

### 4.3 ECS 实体系统模块 (ECS)

**命名空间**: `AFramework.ECS`  
**依赖版本**: com.unity.entities 1.43

#### 4.3.1 模块职责

基于 com.unity.entities 提供增强的实体组件系统，简化ECS开发流程。

#### 4.3.2 功能特性

| 特性 | 描述 |
|------|------|
| 实体生命周期管理 | 创建、销毁、启用、禁用的统一管理 |
| 组件依赖注入 | 自动注入系统依赖的组件引用 |
| 增强事件系统 | 实体创建、销毁、组件变更事件 |
| 查询系统增强 | 简化的查询API和缓存机制 |
| World管理 | 多World支持和生命周期管理 |
| 混合模式支持 | ECS与GameObject的桥接 |
| 调试工具 | 实体查看器、系统性能分析 |

#### 4.3.3 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                ECS 模块架构 (AFramework.ECS)                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   World Manager                      │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │ 默认World   │ │ 服务器World │ │ 客户端World │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   Entity Factory                     │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │ 原型管理    │ │ 实体创建    │ │ 批量操作    │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   System Groups                      │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │初始化组     │ │ 模拟组      │ │ 表现组      │    │   │
│  │  │ Init Group  │ │Simulation   │ │Presentation │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Hybrid Bridge (混合桥接)                │   │
│  │  ┌─────────────────────┐ ┌─────────────────────┐    │   │
│  │  │ GameObject → Entity │ │ Entity → GameObject │    │   │
│  │  └─────────────────────┘ └─────────────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 4.3.4 系统执行顺序

```
┌─────────────────────────────────────────────────────────────┐
│                   系统执行顺序                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 1. InitializationSystemGroup (初始化阶段)            │   │
│  │    └─ 实体创建、资源加载、初始化逻辑                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 2. SimulationSystemGroup (模拟阶段)                  │   │
│  │    ├─ BeginSimulation (输入处理)                     │   │
│  │    ├─ FixedStepSimulation (物理模拟)                 │   │
│  │    └─ EndSimulation (状态同步)                       │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 3. PresentationSystemGroup (表现阶段)                │   │
│  │    └─ 渲染准备、动画更新、UI同步                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

### 4.4 配置模块 (Config)

**命名空间**: `AFramework.Config`

#### 4.4.1 模块职责

提供统一的配置管理系统，支持多种存储位置和序列化格式。

#### 4.4.2 功能特性

| 特性 | 描述 |
|------|------|
| 分层配置 | 默认配置 → 用户配置 → 运行时覆盖 |
| 自动缓存 | 配置读取后自动缓存，避免重复IO |
| 热重载 | 开发模式下配置文件变更自动重载 |
| 类型安全 | 强类型配置类，编译期检查 |
| 加密支持 | 敏感配置支持加密存储 |
| 版本迁移 | 配置版本升级自动迁移 |
| 验证机制 | 配置加载时自动验证合法性 |

#### 4.4.3 存储位置

| 位置 | 读写 | 用途 |
|------|------|------|
| StreamingAssets | 只读 | 默认配置、游戏数据 |
| PersistentDataPath | 读写 | 用户设置、存档数据 |
| Resources | 只读 | 编辑器配置 |
| Addressables | 只读 | 远程配置、DLC配置 |

#### 4.4.4 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│              Config 模块架构 (AFramework.Config)             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              IConfigService 接口                     │   │
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐       │   │
│  │  │ Get<T> │ │ Set<T> │ │ Save() │ │Reload()│       │   │
│  │  └────────┘ └────────┘ └────────┘ └────────┘       │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              ConfigManager                           │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │ 配置注册表  │ │ 缓存管理    │ │ 变更通知    │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│           ┌───────────────┼───────────────┐                 │
│           ▼               ▼               ▼                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ YAML序列化  │ │ Binary序列化│ │ SO序列化    │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              配置验证器                               │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │ 范围验证    │ │ 类型验证    │ │ 自定义验证  │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```


---

### 4.5 调试器模块 (DebugLog)

**命名空间**: `AFramework.DebugLog`

#### 4.5.1 模块职责

提供运行时调试窗口，支持日志查看、性能监控和自定义调试面板。

#### 4.5.2 功能特性

| 特性 | 描述 |
|------|------|
| 运行时日志 | 分级日志显示（Info/Warning/Error） |
| 性能监控 | FPS、内存、DrawCall等实时监控 |
| 控制台命令 | 支持自定义控制台命令 |
| 自定义面板 | 开发者可注册自定义调试面板 |
| 条件编译 | Release版本自动剔除调试代码 |
| 远程调试 | 支持远程设备调试连接 |
| 截图功能 | 一键截图并保存 |

#### 4.5.3 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│            DebugLog 模块架构 (AFramework.DebugLog)           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              DebugLogManager                         │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │ 窗口管理    │ │ 面板注册    │ │ 快捷键绑定  │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│           ┌───────────────┼───────────────┐                 │
│           ▼               ▼               ▼                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ 日志面板    │ │ 性能面板    │ │ 控制台面板  │           │
│  │ LogPanel    │ │ PerfPanel   │ │ConsolePanel │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│           │               │               │                 │
│           ▼               ▼               ▼                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ 内存面板    │ │ Pool面板    │ │ 自定义面板  │           │
│  │MemoryPanel │ │ PoolPanel   │ │CustomPanel  │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              IDebugPanel 接口                        │   │
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐       │   │
│  │  │OnInit()│ │OnDraw()│ │OnTick()│ │OnClose()│       │   │
│  │  └────────┘ └────────┘ └────────┘ └────────┘       │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 4.5.4 内置面板

| 面板 | 功能 |
|------|------|
| 日志面板 | 运行时日志查看、过滤、搜索 |
| 性能面板 | FPS、帧时间、内存使用图表 |
| 内存面板 | 堆内存分析、GC统计 |
| Pool面板 | 池使用率、命中率统计 |
| 资源面板 | 已加载资源列表、引用计数 |
| 控制台面板 | 命令输入、历史记录 |
| 系统信息面板 | 设备信息、Unity版本 |

---

### 4.6 C# 扩展库 (CSharpExtension)

**命名空间**: `AFramework.CSharpExtension`

#### 4.6.1 模块职责

提供常用的C#类型扩展方法，提升开发效率和代码可读性。

#### 4.6.2 扩展分类

| 分类 | 包含内容 |
|------|----------|
| 集合扩展 | List、Array、Dictionary、IEnumerable扩展 |
| 字符串扩展 | 格式化、验证、转换、加密 |
| 数值扩展 | 范围限制、插值、近似比较 |
| 类型扩展 | 反射简化、特性获取 |
| 异步扩展 | Task、ValueTask扩展 |
| Span扩展 | 高性能内存操作 |

#### 4.6.3 设计原则

| 原则 | 描述 |
|------|------|
| 零分配 | 扩展方法尽量避免堆分配 |
| 内联优化 | 使用 AggressiveInlining 特性 |
| 空安全 | 所有扩展方法处理null情况 |
| 命名一致 | 遵循.NET命名规范 |

---

### 4.7 Unity 扩展库 (UnityExtension)

**命名空间**: `AFramework.UnityExtension`

#### 4.7.1 模块职责

提供Unity特定类型的扩展方法和工具类。

#### 4.7.2 扩展分类

| 分类 | 包含内容 |
|------|----------|
| Transform扩展 | 层级操作、位置计算、查找优化 |
| GameObject扩展 | 组件获取、层级管理、激活控制 |
| Component扩展 | 安全获取、批量操作 |
| Vector扩展 | 数学运算、方向计算、投影 |
| Color扩展 | 颜色转换、混合、HSV操作 |
| Rect扩展 | 区域计算、碰撞检测 |
| 协程扩展 | 协程链、条件等待 |

#### 4.7.3 工具类

| 工具类 | 功能 |
|--------|------|
| MathUtility | 数学计算工具 |
| RandomUtility | 随机数生成工具 |
| GizmosUtility | Gizmos绘制工具 |
| LayerUtility | 层级操作工具 |
| PhysicsUtility | 物理计算工具 |

---

### 4.8 算法优化库 (Algorithm)

**命名空间**: `AFramework.Algorithm`

#### 4.8.1 模块职责

提供高性能算法实现，包括SIMD优化和Burst兼容的算法。

#### 4.8.2 算法分类

| 分类 | 包含算法 |
|------|----------|
| 排序算法 | 快速排序、归并排序、基数排序（SIMD优化） |
| 搜索算法 | 二分搜索、KD树、八叉树 |
| 路径算法 | A*、Dijkstra、流场寻路 |
| 空间算法 | BVH、四叉树、空间哈希 |
| 数学算法 | 矩阵运算、向量运算（SIMD优化） |
| 随机算法 | PCG、Xorshift（确定性随机） |

#### 4.8.3 SIMD 优化策略

```
┌─────────────────────────────────────────────────────────────┐
│                     SIMD 优化层次                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 层次1：Unity.Mathematics (float4, int4, etc.)        │   │
│  │ - 跨平台兼容                                          │   │
│  │ - Burst自动向量化                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 层次2：Unity.Burst.Intrinsics                        │   │
│  │ - 显式SIMD指令                                        │   │
│  │ - 平台特定优化                                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 层次3：平台原生 (SSE/AVX/NEON)                        │   │
│  │ - 最高性能                                            │   │
│  │ - 需要平台检测                                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```


---

### 4.9 序列化模块 (Serialization)

**命名空间**: `AFramework.Serialization`

#### 4.9.1 模块职责

提供高性能的二进制序列化框架，支持零拷贝和SIMD优化。

#### 4.9.2 功能特性

| 特性 | 描述 |
|------|------|
| 零拷贝 | 直接内存映射，避免数据复制 |
| 零分配 | 序列化过程无GC分配 |
| SIMD优化 | 批量数据处理使用SIMD指令 |
| 版本兼容 | 支持数据版本迁移 |
| 多态支持 | 支持继承类型的序列化 |
| 自定义格式化器 | 支持自定义类型序列化 |
| 压缩支持 | 可选LZ4/Zstd压缩 |
| YAML支持 | 支持YAML格式配置文件 |

#### 4.9.3 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│        Serialization 模块架构 (AFramework.Serialization)     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              ISerializer 接口                        │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐         │   │
│  │  │Serialize()│ │Deserialize│ │GetSize()  │         │   │
│  │  └───────────┘ └───────────┘ └───────────┘         │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│           ┌───────────────┼───────────────┐                 │
│           ▼               ▼               ▼                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │BinarySerializer│ │YamlSerializer│ │MessagePack │           │
│  │ (高性能)    │ │ (可读性)    │ │ (兼容性)   │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              格式化器注册表                           │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │ 基础类型    │ │ Unity类型   │ │ 自定义类型  │    │   │
│  │  │ Formatter   │ │ Formatter   │ │ Formatter   │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              缓冲区管理                               │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │ 池化缓冲区  │ │ 零拷贝读取  │ │ 流式写入    │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 4.9.4 支持的类型

| 类别 | 类型 |
|------|------|
| 基础类型 | bool, byte, short, int, long, float, double, string |
| Unity类型 | Vector2/3/4, Quaternion, Color, Rect, Bounds |
| 集合类型 | Array, List, Dictionary, HashSet |
| 特殊类型 | Nullable, Enum, DateTime, TimeSpan, Guid |
| ECS类型 | Entity, NativeArray, NativeList, BlobAssetReference |

---

### 4.10 依赖注入模块 (DI)

**命名空间**: `AFramework.DI`

#### 4.10.1 模块职责

提供高性能的依赖注入容器，管理对象的创建、依赖关系和生命周期。

#### 4.10.2 功能特性

| 特性 | 描述 |
|------|------|
| 构造函数注入 | 自动解析构造函数参数 |
| 属性注入 | 标记属性自动注入 |
| 方法注入 | 标记方法自动调用并注入参数 |
| 生命周期管理 | Singleton、Scoped、Transient |
| 分层容器 | 父子容器继承关系 |
| 延迟解析 | Lazy<T>、Func<T> 支持 |
| 集合注入 | IEnumerable<T> 注入所有实现 |
| 条件注册 | 基于条件的服务注册 |

#### 4.10.3 生命周期

| 生命周期 | 描述 | 适用场景 |
|----------|------|----------|
| Singleton | 全局唯一实例 | 管理器、服务 |
| Scoped | 作用域内唯一 | 场景级服务 |
| Transient | 每次解析新实例 | 临时对象 |

#### 4.10.4 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                DI 模块架构 (AFramework.DI)                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              IContainerBuilder 接口                  │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐            │   │
│  │  │Register()│ │ Build()  │ │Configure()│            │   │
│  │  └──────────┘ └──────────┘ └──────────┘            │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              IContainer 接口                         │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐            │   │
│  │  │Resolve() │ │CreateScope│ │ Dispose()│            │   │
│  │  └──────────┘ └──────────┘ └──────────┘            │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Container 实现                          │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │ 注册表      │ │ 解析器      │ │ 生命周期    │    │   │
│  │  │ Registry    │ │ Resolver    │ │ Lifetime    │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Unity 集成                              │   │
│  │  ┌─────────────────────┐ ┌─────────────────────┐    │   │
│  │  │ LifetimeScope       │ │ MonoBehaviour注入   │    │   │
│  │  │ (场景容器)          │ │                     │    │   │
│  │  └─────────────────────┘ └─────────────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

### 4.11 Burst 编译扩展模块 (BurstExtension)

**命名空间**: `AFramework.Burst`  
**依赖版本**: com.unity.burst 1.8.27

#### 4.11.1 模块职责

提供Burst编译器的集成支持和优化工具。

#### 4.11.2 功能特性

| 特性 | 描述 |
|------|------|
| Job封装 | 简化IJob、IJobParallelFor等的使用 |
| 函数指针 | Burst兼容的函数指针支持 |
| 共享静态数据 | SharedStatic<T> 封装 |
| 调试支持 | Burst调试信息和断言 |
| 性能分析 | Burst编译性能分析工具 |

#### 4.11.3 Burst 兼容性指南

| 支持 | 不支持 |
|------|--------|
| 值类型 (struct) | 引用类型 (class) |
| 基础数值类型 | string (部分支持) |
| Unity.Mathematics | System.Math (部分) |
| NativeContainer | 托管集合 |
| 函数指针 | 委托 (delegate) |
| 静态只读字段 | 静态可变字段 |

---

### 4.12 插件扩展模块 (Extension)

**命名空间**: `AFramework.Extension`

#### 4.12.1 模块职责

提供与UniTask和R3的集成支持，增强异步编程能力。

#### 4.12.2 UniTask 集成

| 功能 | 描述 |
|------|------|
| 资源异步加载 | Addressables + UniTask |
| 协程转换 | Coroutine → UniTask |
| 取消令牌 | CancellationToken 支持 |
| 进度报告 | IProgress<float> 支持 |
| 异常处理 | 统一异常处理机制 |

#### 4.12.3 R3 集成

| 功能 | 描述 |
|------|------|
| 事件流 | Observable 事件流处理 |
| UI绑定 | 响应式UI数据绑定 |
| 生命周期 | 自动订阅管理 |
| 操作符 | 丰富的流操作符 |

#### 4.12.4 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│           Extension 模块架构 (AFramework.Extension)          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              UniTask 扩展层                          │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │资源加载扩展 │ │ 协程桥接    │ │ 超时/重试   │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              R3 扩展层                               │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │ 事件桥接    │ │ UI绑定     │ │ 生命周期    │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              框架集成层                              │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │ ResourceSystem ←→ UniTask                    │    │   │
│  │  │ EventSystem ←→ R3                            │    │   │
│  │  │ TaskSystem ←→ UniTask + R3                   │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```


---

### 4.13 内存数据库模块 (AFrameworkDB)

**命名空间**: `AFramework.DB`

#### 4.13.1 模块职责

提供高性能的内存数据库，用于游戏配置数据、静态数据的存储和查询。

#### 4.13.2 功能特性

| 特性 | 描述 |
|------|------|
| 不可变数据 | 数据加载后不可修改，保证线程安全 |
| 源代码生成 | 自动生成强类型表和数据库类 |
| 索引查询 | 支持主键、唯一键、普通索引 |
| 范围查找 | 支持范围查询和排序 |
| 数据验证 | 加载时自动验证数据完整性 |
| 二进制序列化 | 使用MessagePack高效序列化 |
| 热重载 | 开发模式支持数据热重载 |

#### 4.13.3 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│          AFrameworkDB 模块架构 (AFramework.DB)               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              数据定义层                              │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │ [Table]     │ │ [PrimaryKey]│ │ [Index]     │    │   │
│  │  │ 表定义特性  │ │ 主键特性    │ │ 索引特性    │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼ (源代码生成)                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              生成代码层                              │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │ XxxTable    │ │ XxxDatabase │ │ XxxBuilder  │    │   │
│  │  │ (表类)      │ │ (数据库类)  │ │ (构建器)    │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              运行时层                                │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │ 数据加载    │ │ 索引构建    │ │ 查询执行    │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              查询API                                 │   │
│  │  ┌──────────────────────────────────────────────┐   │   │
│  │  │ FindByPrimaryKey(key)     // 主键查询        │   │   │
│  │  │ FindByIndex(indexValue)   // 索引查询        │   │   │
│  │  │ FindRange(min, max)       // 范围查询        │   │   │
│  │  │ FindAll()                 // 全表查询        │   │   │
│  │  │ FindClosest(value)        // 最近值查询      │   │   │
│  │  └──────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 4.13.4 索引类型

| 索引类型 | 描述 | 查询复杂度 |
|----------|------|------------|
| PrimaryKey | 主键索引，唯一且必须 | O(1) |
| UniqueKey | 唯一索引，可选 | O(1) |
| NonUnique | 普通索引，允许重复 | O(log n) |
| Range | 范围索引，支持范围查询 | O(log n + k) |

#### 4.13.5 数据流程

```
┌─────────────────────────────────────────────────────────────┐
│                     数据流程                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐  │
│  │ Excel/  │───▶│ 数据    │───▶│ Binary  │───▶│ 运行时  │  │
│  │ CSV     │    │ 验证    │    │ 序列化  │    │ 加载    │  │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘  │
│       │                                             │       │
│       │ (编辑器工具)                                │       │
│       ▼                                             ▼       │
│  ┌─────────┐                                  ┌─────────┐  │
│  │ 源代码  │                                  │ 内存    │  │
│  │ 生成    │                                  │ 数据库  │  │
│  └─────────┘                                  └─────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

### 4.14 事件消息系统模块 (EventSystem)

**命名空间**: `AFramework.EventSystem`

#### 4.14.1 模块职责

提供高性能的消息传递和事件系统，支持发布-订阅、请求-响应模式。

#### 4.14.2 功能特性

| 特性 | 描述 |
|------|------|
| 发布-订阅 | 类型安全的Pub/Sub机制 |
| 请求-响应 | 同步/异步请求响应模式 |
| 事件ID | 支持int/string类型的事件ID |
| 零GC | 事件分发过程零GC分配 |
| 过滤器 | 支持消息过滤和拦截 |
| 缓冲区 | 支持消息缓冲和批处理 |
| 跨进程 | 支持进程间通信（可选） |

#### 4.14.3 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│        EventSystem 模块架构 (AFramework.EventSystem)         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              消息管道层 (MessagePipe)                │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │IPublisher<T>│ │ISubscriber<T>│ │IRequestHandler│   │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              事件系统层                              │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │ 事件总线    │ │ 事件队列    │ │ 事件池      │    │   │
│  │  │ EventBus    │ │ EventQueue  │ │ EventPool   │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│           ┌───────────────┼───────────────┐                 │
│           ▼               ▼               ▼                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ 同步分发    │ │ 异步分发    │ │ 延迟分发    │           │
│  │ Sync        │ │ Async       │ │ Deferred    │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              过滤器管道                              │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │   │
│  │  │ 日志    │→│ 验证    │→│ 转换    │→│ 处理    │   │   │
│  │  │ Filter  │ │ Filter  │ │ Filter  │ │ Handler │   │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 4.14.4 事件类型

| 类型 | 描述 | 使用场景 |
|------|------|----------|
| 强类型事件 | 基于泛型的类型安全事件 | 编译期检查、IDE支持 |
| ID事件(int) | 基于整数ID的事件 | 高性能、网络同步 |
| ID事件(string) | 基于字符串ID的事件 | 可读性、动态事件 |

#### 4.14.5 消息流模式

```
┌─────────────────────────────────────────────────────────────┐
│                     消息流模式                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  模式1：发布-订阅 (Pub/Sub)                                 │
│  ┌─────────┐         ┌─────────┐         ┌─────────┐       │
│  │Publisher│────────▶│  Broker │────────▶│Subscriber│       │
│  └─────────┘         └─────────┘         └─────────┘       │
│                           │              ┌─────────┐       │
│                           └─────────────▶│Subscriber│       │
│                                          └─────────┘       │
│                                                             │
│  模式2：请求-响应 (Request/Response)                        │
│  ┌─────────┐  Request  ┌─────────┐  Response ┌─────────┐   │
│  │Requester│──────────▶│ Handler │──────────▶│Requester│   │
│  └─────────┘           └─────────┘           └─────────┘   │
│                                                             │
│  模式3：事件流 (Event Stream)                               │
│  ┌─────────┐         ┌─────────┐         ┌─────────┐       │
│  │ Source  │────────▶│ Stream  │────────▶│Observer │       │
│  └─────────┘         │ (R3)    │         └─────────┘       │
│                      └─────────┘                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```


---

### 4.15 任务系统模块 (TaskSystem)

**命名空间**: `AFramework.TaskSystem`

#### 4.15.1 模块职责

提供具有前提条件和事件驱动完成的异步任务管理系统。

#### 4.15.2 功能特性

| 特性 | 描述 |
|------|------|
| 任务依赖 | 支持任务间的依赖关系 |
| 前提条件 | 任务执行前的条件检查 |
| 事件驱动 | 基于事件的任务完成通知 |
| 生命周期管理 | 自动管理任务的创建和销毁 |
| 优先级 | 支持任务优先级排序 |
| 取消支持 | 支持任务取消和超时 |
| 进度报告 | 支持任务进度回调 |
| 重试机制 | 失败任务自动重试 |

#### 4.15.3 任务状态

```
┌─────────────────────────────────────────────────────────────┐
│                     任务状态机                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                      ┌─────────┐                            │
│                      │ Created │                            │
│                      └────┬────┘                            │
│                           │ Start()                         │
│                           ▼                                 │
│  ┌─────────┐        ┌─────────┐        ┌─────────┐         │
│  │ Waiting │◀──────▶│ Running │───────▶│Completed│         │
│  │(等待依赖)│        └────┬────┘        └─────────┘         │
│  └─────────┘             │                                  │
│                          │ Cancel()/Timeout                 │
│                          ▼                                  │
│                    ┌─────────┐                              │
│                    │Cancelled│                              │
│                    └─────────┘                              │
│                          │ Error                            │
│                          ▼                                  │
│                    ┌─────────┐                              │
│                    │ Failed  │                              │
│                    └─────────┘                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 4.15.4 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│          TaskSystem 模块架构 (AFramework.TaskSystem)         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              ITask 接口                              │   │
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐       │   │
│  │  │Start() │ │Cancel()│ │OnComplete│ │Progress│       │   │
│  │  └────────┘ └────────┘ └────────┘ └────────┘       │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│           ┌───────────────┼───────────────┐                 │
│           ▼               ▼               ▼                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ SimpleTask  │ │SequenceTask │ │ ParallelTask│           │
│  │ (单一任务)  │ │ (顺序任务)  │ │ (并行任务)  │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              TaskManager                             │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │ 任务注册表  │ │ 依赖解析    │ │ 调度器      │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              前提条件系统                            │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │ 条件检查    │ │ 条件组合    │ │ 条件监听    │    │   │
│  │  │ (AND/OR)    │ │ (复合条件)  │ │ (事件触发)  │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 4.15.5 任务类型

| 类型 | 描述 | 使用场景 |
|------|------|----------|
| SimpleTask | 单一异步任务 | 资源加载、网络请求 |
| SequenceTask | 顺序执行的任务组 | 流程控制、初始化序列 |
| ParallelTask | 并行执行的任务组 | 批量加载、并发处理 |
| ConditionalTask | 条件触发的任务 | 事件响应、状态变更 |
| RepeatingTask | 重复执行的任务 | 定时任务、轮询 |

---

### 4.16 资源管理系统模块 (ResourceSystem)

**命名空间**: `AFramework.ResourceSystem`  
**依赖版本**: com.unity.addressables 1.28

#### 4.16.1 模块职责

基于Addressables提供完整的资源管理解决方案，包括加载、缓存、生命周期管理。

#### 4.16.2 功能特性

| 特性 | 描述 |
|------|------|
| 统一加载API | 屏蔽Addressables复杂性 |
| 引用计数 | 自动管理资源引用 |
| 生命周期绑定 | 资源与GameObject生命周期绑定 |
| 预加载系统 | 支持资源预加载和预热 |
| Pool集成 | 与Pool模块无缝集成 |
| 异步加载 | 基于UniTask的异步加载 |
| 加载优先级 | 支持资源加载优先级 |
| 内存监控 | 资源内存使用监控 |

#### 4.16.3 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│      ResourceSystem 模块架构 (AFramework.ResourceSystem)     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              IResourceService 接口                   │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐            │   │
│  │  │LoadAsync()│ │Release() │ │Preload() │            │   │
│  │  └──────────┘ └──────────┘ └──────────┘            │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              ResourceManager                         │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │ 加载器      │ │ 缓存管理    │ │ 引用计数    │    │   │
│  │  │ Loader      │ │ Cache       │ │ RefCount    │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│           ┌───────────────┼───────────────┐                 │
│           ▼               ▼               ▼                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ Asset加载   │ │ 场景加载    │ │ 实例化      │           │
│  │ LoadAsset   │ │ LoadScene   │ │ Instantiate │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              生命周期管理                            │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │ ResourceHandle (资源句柄)                    │    │   │
│  │  │ - 自动引用计数                               │    │   │
│  │  │ - 生命周期绑定                               │    │   │
│  │  │ - 自动释放                                   │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Pool集成                                │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │ PooledResourceHandle                         │    │   │
│  │  │ - 实例化时从池获取                           │    │   │
│  │  │ - 释放时归还池                               │    │   │
│  │  │ - 自动预热                                   │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 4.16.4 资源加载流程

```
┌─────────────────────────────────────────────────────────────┐
│                     资源加载流程                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐  │
│  │ 请求    │───▶│ 缓存    │───▶│ 加载    │───▶│ 回调    │  │
│  │ Request │    │ Check   │    │ Load    │    │Callback │  │
│  └─────────┘    └────┬────┘    └────┬────┘    └─────────┘  │
│                      │              │                       │
│                      │ 命中         │ 未命中                │
│                      ▼              ▼                       │
│                ┌─────────┐    ┌─────────┐                  │
│                │ 返回    │    │Addressables│                  │
│                │ 缓存    │    │ 加载    │                  │
│                └─────────┘    └────┬────┘                  │
│                                    │                       │
│                                    ▼                       │
│                              ┌─────────┐                   │
│                              │ 加入    │                   │
│                              │ 缓存    │                   │
│                              └─────────┘                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 4.16.5 内存管理策略

| 策略 | 描述 | 适用场景 |
|------|------|----------|
| 引用计数 | 引用归零时释放 | 通用资源 |
| LRU缓存 | 最近最少使用淘汰 | 频繁切换的资源 |
| 预算限制 | 超出内存预算时释放 | 内存敏感场景 |
| 手动管理 | 开发者显式控制 | 特殊需求 |


---

---

> 文档结束
> 
> Aggregation Framework (AFramework) - 高性能 Unity 聚合开发框架
> 
> 版权所有 © 2025
