# AFramework.DI 依赖注入框架技术文档

> 版本：1.0.0  
> 命名空间：AFramework.DI  
> 适用 Unity 版本：2022.3 LTS ~ Unity 6.x  
> 最后更新：2026年1月

---

## 目录

1. [框架概述](#1-框架概述)
2. [核心设计理念](#2-核心设计理念)
3. [架构设计](#3-架构设计)
4. [依赖注入系统](#4-依赖注入系统)
5. [生命周期管理](#5-生命周期管理)
6. [作用域系统](#6-作用域系统)
7. [Unity 集成](#7-unity-集成)
8. [注册系统](#8-注册系统)
9. [解析系统](#9-解析系统)
10. [入口点系统](#10-入口点系统)
11. [诊断系统](#11-诊断系统)
12. [性能优化](#12-性能优化)
13. [扩展机制](#13-扩展机制)
14. [最佳实践](#14-最佳实践)
15. [与其他模块集成](#15-与其他模块集成)

---

## 1. 框架概述

### 1.1 框架定位

AFramework.DI 是 Aggregation Framework 的核心依赖注入模块，专为 Unity 游戏开发设计的高性能依赖注入容器。

框架通过自动管理对象的创建、依赖关系和生命周期，实现松耦合、可测试、可维护的代码架构，是构建大型 Unity 项目的基础设施。

### 1.2 设计目标

| 目标 | 描述 |
|------|------|
| 高性能 | 零GC分配的解析路径、反射缓存、内联优化 |
| 类型安全 | 编译期类型检查，减少运行时错误 |
| Unity 深度集成 | 与 Unity 生命周期、场景系统无缝集成 |
| 易用性 | 简洁直观的 API，低学习曲线 |
| 可扩展性 | 支持自定义提供者、注入器、生命周期 |
| 诊断友好 | 完善的诊断工具，快速定位问题 |

### 1.3 核心特性一览

```
┌─────────────────────────────────────────────────────────────┐
│                    AFramework.DI 核心特性                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  多种注入   │  │  生命周期   │  │  作用域     │         │
│  │  方式支持   │  │  管理       │  │  系统       │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  Unity      │  │  入口点     │  │  诊断       │         │
│  │  深度集成   │  │  系统       │  │  工具       │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  模块化     │  │  零GC       │  │  ECS        │         │
│  │  安装器     │  │  解析       │  │  集成       │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 1.4 与 VContainer 的对比

| 特性 | AFramework.DI | VContainer |
|------|---------------|------------|
| 命名空间 | AFramework.DI | VContainer |
| Unity 集成 | 深度集成 AFramework 生态 | 独立框架 |
| ECS 支持 | 原生支持 AFramework.ECS | 可选模块 |
| 事件系统 | 集成 AFramework.EventSystem | 无内置 |
| 对象池 | 集成 AFramework.Pool | 无内置 |
| 诊断工具 | 集成 AFramework.DebugLog | 独立窗口 |
| 本地化 | 支持编辑器本地化 | 无 |

---

## 2. 核心设计理念

### 2.1 依赖倒置原则 (DIP)

AFramework.DI 的核心理念是实现依赖倒置原则：

```
┌─────────────────────────────────────────────────────────────┐
│                    依赖倒置原则                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  传统依赖关系：                                              │
│  ┌─────────────┐         ┌─────────────┐                   │
│  │  高层模块   │────────▶│  低层模块   │                   │
│  │ (业务逻辑)  │  依赖    │ (基础设施)  │                   │
│  └─────────────┘         └─────────────┘                   │
│                                                             │
│  依赖倒置后：                                                │
│  ┌─────────────┐         ┌─────────────┐                   │
│  │  高层模块   │         │  低层模块   │                   │
│  │ (业务逻辑)  │         │ (基础设施)  │                   │
│  └──────┬──────┘         └──────┬──────┘                   │
│         │                       │                          │
│         │  依赖                 │  实现                    │
│         ▼                       ▼                          │
│  ┌─────────────────────────────────────┐                   │
│  │            抽象接口                  │                   │
│  └─────────────────────────────────────┘                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 控制反转 (IoC)

框架通过控制反转实现对象创建和依赖管理的解耦：

```
┌─────────────────────────────────────────────────────────────┐
│                    控制反转流程                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    注册     ┌─────────────┐               │
│  │  服务类型   │────────────▶│   容器      │               │
│  │  实现类型   │             │ Container   │               │
│  └─────────────┘             └──────┬──────┘               │
│                                     │                       │
│                                     │ 解析                  │
│                                     ▼                       │
│  ┌─────────────┐    注入     ┌─────────────┐               │
│  │  消费者     │◀────────────│  实例       │               │
│  │  Consumer   │             │  Instance   │               │
│  └─────────────┘             └─────────────┘               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 组合根模式

所有依赖关系在组合根（Composition Root）统一配置：

```
┌─────────────────────────────────────────────────────────────┐
│                    组合根模式                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              组合根 (LifetimeScope)                  │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │  所有依赖注册集中在此                        │    │   │
│  │  │  - 服务注册                                  │    │   │
│  │  │  - 生命周期配置                              │    │   │
│  │  │  - 接口绑定                                  │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│           ┌───────────────┼───────────────┐                 │
│           ▼               ▼               ▼                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │  业务模块A  │ │  业务模块B  │ │  业务模块C  │           │
│  │  (无DI代码) │ │  (无DI代码) │ │  (无DI代码) │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.4 设计原则遵循

| 原则 | 框架实现 |
|------|----------|
| 单一职责 (SRP) | 容器只负责依赖管理，不涉及业务逻辑 |
| 开闭原则 (OCP) | 通过接口扩展，不修改核心代码 |
| 里氏替换 (LSP) | 所有注册实现可替换为接口类型 |
| 接口隔离 (ISP) | 提供细粒度的接口定义 |
| 依赖倒置 (DIP) | 高层模块依赖抽象，由容器注入实现 |

---

## 3. 架构设计

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                AFramework.DI 整体架构                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    应用层                            │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │LifetimeScope│ │  Installer  │ │ EntryPoint  │    │   │
│  │  │ (场景容器)  │ │ (模块安装)  │ │ (入口点)    │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    容器层                            │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │  Container  │ │ContainerBuilder│ │  Registry  │    │   │
│  │  │  (容器)     │ │ (构建器)    │ │ (注册表)    │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    核心层                            │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │ Registration│ │  Resolver   │ │  Injector   │    │   │
│  │  │ (注册信息)  │ │ (解析器)    │ │ (注入器)    │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    提供者层                          │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │InstanceProvider│ │FactoryProvider│ │ComponentProvider│   │
│  │  │ (实例提供)  │ │ (工厂提供)  │ │ (组件提供)  │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 核心组件关系

```
┌─────────────────────────────────────────────────────────────┐
│                    核心组件关系图                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐                                       │
│  │ContainerBuilder │                                       │
│  │  - Register()   │                                       │
│  │  - Build()      │                                       │
│  └────────┬────────┘                                       │
│           │ 构建                                            │
│           ▼                                                 │
│  ┌─────────────────┐      ┌─────────────────┐              │
│  │   Container     │─────▶│    Registry     │              │
│  │  - Resolve()    │ 持有 │  - 注册信息集合 │              │
│  │  - CreateScope()│      │  - 类型映射     │              │
│  └────────┬────────┘      └─────────────────┘              │
│           │                                                 │
│           │ 使用                                            │
│           ▼                                                 │
│  ┌─────────────────┐      ┌─────────────────┐              │
│  │    Resolver     │─────▶│    Injector     │              │
│  │  - 依赖解析     │ 调用 │  - 构造函数注入 │              │
│  │  - 循环检测     │      │  - 属性注入     │              │
│  └────────┬────────┘      │  - 方法注入     │              │
│           │               └─────────────────┘              │
│           │ 委托                                            │
│           ▼                                                 │
│  ┌─────────────────┐                                       │
│  │InstanceProvider │                                       │
│  │  - 实例创建     │                                       │
│  │  - 生命周期管理 │                                       │
│  └─────────────────┘                                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.3 分层容器设计

```
┌─────────────────────────────────────────────────────────────┐
│                    分层容器架构                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              根容器 (Root Container)                 │   │
│  │  ┌───────────────────────────────────────────────┐  │   │
│  │  │  全局单例服务                                  │  │   │
│  │  │  - 配置服务 (IConfigService)                  │  │   │
│  │  │  - 日志服务 (ILogService)                     │  │   │
│  │  │  - 本地化服务 (ILocalizationService)          │  │   │
│  │  │  - 事件总线 (IEventBus)                       │  │   │
│  │  └───────────────────────────────────────────────┘  │   │
│  └──────────────────────────┬──────────────────────────┘   │
│                             │ 父容器                        │
│              ┌──────────────┴──────────────┐                │
│              ▼                             ▼                │
│  ┌─────────────────────┐     ┌─────────────────────┐       │
│  │ 场景容器A           │     │ 场景容器B           │       │
│  │ (Scene Container)   │     │ (Scene Container)   │       │
│  │  ┌───────────────┐  │     │  ┌───────────────┐  │       │
│  │  │ 场景级服务    │  │     │  │ 场景级服务    │  │       │
│  │  │ - 资源管理    │  │     │  │ - 资源管理    │  │       │
│  │  │ - 对象池      │  │     │  │ - 对象池      │  │       │
│  │  │ - UI管理      │  │     │  │ - UI管理      │  │       │
│  │  └───────────────┘  │     │  └───────────────┘  │       │
│  └──────────┬──────────┘     └─────────────────────┘       │
│             │ 父容器                                        │
│             ▼                                               │
│  ┌─────────────────────┐                                   │
│  │ 子容器              │                                   │
│  │ (Child Container)   │                                   │
│  │  ┌───────────────┐  │                                   │
│  │  │ 局部服务      │  │                                   │
│  │  │ - UI面板      │  │                                   │
│  │  │ - 临时对象    │  │                                   │
│  │  └───────────────┘  │                                   │
│  └─────────────────────┘                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.4 模块依赖关系

```
┌─────────────────────────────────────────────────────────────┐
│                AFramework.DI 模块依赖                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                    ┌─────────────┐                          │
│                    │AFramework.DI│                          │
│                    └──────┬──────┘                          │
│                           │                                 │
│           ┌───────────────┼───────────────┐                 │
│           ▼               ▼               ▼                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │CSharpExtension│ │UnityExtension│ │  DebugLog   │           │
│  │ (必需)      │ │ (必需)      │ │ (可选)      │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│                                                             │
│  可选集成模块：                                              │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │    Pool     │ │EventSystem  │ │     ECS     │           │
│  │ (对象池)    │ │ (事件系统)  │ │ (实体系统)  │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```


---

## 4. 依赖注入系统

### 4.1 注入方式概述

AFramework.DI 支持四种主要的依赖注入方式，每种方式适用于不同的场景：

| 注入方式 | 优先级 | 推荐程度 | 适用场景 |
|----------|--------|----------|----------|
| 构造函数注入 | 最高 | ★★★★★ | 必需依赖、不可变依赖 |
| 方法注入 | 高 | ★★★★☆ | 需要注入时执行逻辑 |
| 属性注入 | 中 | ★★★☆☆ | 可选依赖、循环依赖解决 |
| 字段注入 | 低 | ★★☆☆☆ | 快速原型、MonoBehaviour |

### 4.2 构造函数注入

构造函数注入是最推荐的注入方式，它确保对象在创建时所有必需依赖都已就绪。

```
┌─────────────────────────────────────────────────────────────┐
│                    构造函数注入流程                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    分析     ┌─────────────┐               │
│  │  目标类型   │────────────▶│  构造函数   │               │
│  │  Target     │             │  参数列表   │               │
│  └─────────────┘             └──────┬──────┘               │
│                                     │                       │
│                                     │ 逐个解析              │
│                                     ▼                       │
│  ┌─────────────┐    解析     ┌─────────────┐               │
│  │  容器       │◀────────────│  参数类型   │               │
│  │  Container  │             │  依赖       │               │
│  └──────┬──────┘             └─────────────┘               │
│         │                                                   │
│         │ 创建实例                                          │
│         ▼                                                   │
│  ┌─────────────┐                                           │
│  │  目标实例   │                                           │
│  │  Instance   │                                           │
│  └─────────────┘                                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 构造函数选择规则

| 规则 | 描述 |
|------|------|
| [Inject] 标记优先 | 标记了 [Inject] 特性的构造函数优先选择 |
| 参数最多优先 | 无标记时选择参数最多的公共构造函数 |
| 无参构造函数 | 作为最后的回退选项 |

#### 构造函数注入特点

| 特点 | 说明 |
|------|------|
| 不可变性 | 依赖通过 readonly 字段保存，保证不可变 |
| 完整性 | 对象创建时所有依赖必须可用 |
| 显式依赖 | 依赖关系在构造函数签名中清晰可见 |
| 易于测试 | 单元测试时可轻松传入模拟对象 |

### 4.3 方法注入

方法注入通过 [Inject] 特性标记方法，容器在对象创建后自动调用该方法并注入参数。

```
┌─────────────────────────────────────────────────────────────┐
│                    方法注入流程                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    创建     ┌─────────────┐               │
│  │  容器       │────────────▶│  目标实例   │               │
│  │  Container  │             │  (未注入)   │               │
│  └──────┬──────┘             └──────┬──────┘               │
│         │                           │                       │
│         │ 扫描 [Inject] 方法        │                       │
│         ▼                           ▼                       │
│  ┌─────────────┐    解析     ┌─────────────┐               │
│  │  方法参数   │────────────▶│  依赖实例   │               │
│  │  类型列表   │             │  集合       │               │
│  └─────────────┘             └──────┬──────┘               │
│                                     │                       │
│                                     │ 调用方法              │
│                                     ▼                       │
│                              ┌─────────────┐               │
│                              │  目标实例   │               │
│                              │  (已注入)   │               │
│                              └─────────────┘               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 方法注入特点

| 特点 | 说明 |
|------|------|
| 初始化逻辑 | 可在注入时执行初始化代码 |
| 多方法支持 | 可标记多个方法，按声明顺序调用 |
| 继承支持 | 基类的注入方法也会被调用 |
| 灵活性 | 适合需要在注入时执行逻辑的场景 |

### 4.4 属性注入

属性注入通过 [Inject] 特性标记属性，容器在对象创建后自动设置属性值。

```
┌─────────────────────────────────────────────────────────────┐
│                    属性注入流程                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    创建     ┌─────────────┐               │
│  │  容器       │────────────▶│  目标实例   │               │
│  │  Container  │             │  (未注入)   │               │
│  └──────┬──────┘             └──────┬──────┘               │
│         │                           │                       │
│         │ 扫描 [Inject] 属性        │                       │
│         ▼                           ▼                       │
│  ┌─────────────┐    解析     ┌─────────────┐               │
│  │  属性类型   │────────────▶│  依赖实例   │               │
│  │  列表       │             │             │               │
│  └─────────────┘             └──────┬──────┘               │
│                                     │                       │
│                                     │ 设置属性              │
│                                     ▼                       │
│                              ┌─────────────┐               │
│                              │  目标实例   │               │
│                              │  (已注入)   │               │
│                              └─────────────┘               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 属性注入特点

| 特点 | 说明 |
|------|------|
| 可选依赖 | 适合非必需的依赖 |
| 循环依赖 | 可用于解决循环依赖问题 |
| 封装性 | 比字段注入有更好的封装 |
| 延迟设置 | 属性可在对象创建后设置 |

### 4.5 字段注入

字段注入通过 [Inject] 特性标记字段，容器在对象创建后自动设置字段值。

```
┌─────────────────────────────────────────────────────────────┐
│                    字段注入流程                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    创建     ┌─────────────┐               │
│  │  容器       │────────────▶│  目标实例   │               │
│  │  Container  │             │  (未注入)   │               │
│  └──────┬──────┘             └──────┬──────┘               │
│         │                           │                       │
│         │ 扫描 [Inject] 字段        │                       │
│         ▼                           ▼                       │
│  ┌─────────────┐    解析     ┌─────────────┐               │
│  │  字段类型   │────────────▶│  依赖实例   │               │
│  │  列表       │             │             │               │
│  └─────────────┘             └──────┬──────┘               │
│                                     │                       │
│                                     │ 设置字段              │
│                                     ▼                       │
│                              ┌─────────────┐               │
│                              │  目标实例   │               │
│                              │  (已注入)   │               │
│                              └─────────────┘               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 字段注入特点

| 特点 | 说明 |
|------|------|
| 简洁性 | 代码最简洁，适合快速原型 |
| MonoBehaviour | Unity MonoBehaviour 无法使用构造函数，字段注入是常用选择 |
| 封装性差 | 破坏封装，不推荐在纯 C# 类中使用 |
| 测试困难 | 单元测试时需要使用反射设置依赖 |

### 4.6 参数注入

参数注入允许在注册时为特定参数指定值，支持按名称、按类型或通过工厂函数注入。

```
┌─────────────────────────────────────────────────────────────┐
│                    参数注入类型                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  按名称注入                                          │   │
│  │  WithParameter("paramName", value)                   │   │
│  │  - 精确匹配参数名称                                  │   │
│  │  - 适合同类型多参数场景                              │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  按类型注入                                          │   │
│  │  WithParameter<TParam>(value)                        │   │
│  │  - 匹配参数类型                                      │   │
│  │  - 适合类型唯一的参数                                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  工厂函数注入                                        │   │
│  │  WithParameter("paramName", resolver => ...)         │   │
│  │  - 动态计算参数值                                    │   │
│  │  - 可访问容器解析其他依赖                            │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.7 键值注入

键值注入允许为同一类型的多个注册指定不同的键值，实现多态注入。

```
┌─────────────────────────────────────────────────────────────┐
│                    键值注入机制                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  注册端：                                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Register<IService, ServiceA>().Keyed("A")           │   │
│  │  Register<IService, ServiceB>().Keyed("B")           │   │
│  │  Register<IService, ServiceC>().Keyed("C")           │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  消费端：                                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  [Inject]                                            │   │
│  │  [Key("A")]                                          │   │
│  │  private IService _serviceA;                         │   │
│  │                                                      │   │
│  │  [Inject]                                            │   │
│  │  [Key("B")]                                          │   │
│  │  private IService _serviceB;                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  解析流程：                                                  │
│  ┌─────────────┐    查找     ┌─────────────┐               │
│  │  类型+键值  │────────────▶│  注册信息   │               │
│  │  IService+A │             │  ServiceA   │               │
│  └─────────────┘             └─────────────┘               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.8 注入特性一览

| 特性 | 用途 | 适用目标 |
|------|------|----------|
| [Inject] | 标记需要注入的成员 | 构造函数、方法、属性、字段 |
| [Key] | 指定键值注入 | 参数、属性、字段 |
| [Optional] | 标记可选依赖 | 参数、属性、字段 |
| [FromParent] | 从父容器解析 | 参数、属性、字段 |

---

## 5. 生命周期管理

### 5.1 生命周期类型

AFramework.DI 提供三种生命周期模式，满足不同的对象管理需求：

```
┌─────────────────────────────────────────────────────────────┐
│                    生命周期类型对比                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Singleton (单例)                                    │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │  容器生命周期内只创建一个实例                │    │   │
│  │  │  所有解析请求返回同一实例                    │    │   │
│  │  │  容器销毁时实例被销毁                        │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Scoped (作用域)                                     │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │  作用域内只创建一个实例                      │    │   │
│  │  │  不同作用域拥有不同实例                      │    │   │
│  │  │  作用域销毁时实例被销毁                      │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Transient (瞬态)                                    │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │  每次解析都创建新实例                        │    │   │
│  │  │  容器不跟踪实例生命周期                      │    │   │
│  │  │  调用者负责实例的销毁                        │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 生命周期选择指南

| 生命周期 | 适用场景 | 示例 |
|----------|----------|------|
| Singleton | 全局共享状态、无状态服务、昂贵的初始化 | 配置服务、日志服务、事件总线 |
| Scoped | 场景级服务、请求级服务、需要隔离的状态 | UI管理器、资源管理器、场景控制器 |
| Transient | 无状态操作、轻量级对象、每次需要新实例 | 命令对象、DTO、临时计算器 |

### 5.3 生命周期图示

```
┌─────────────────────────────────────────────────────────────┐
│                    生命周期时序图                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  时间轴 ──────────────────────────────────────────────────▶ │
│                                                             │
│  Singleton:                                                 │
│  ┌──────────────────────────────────────────────────────┐  │
│  │████████████████████████████████████████████████████│  │
│  └──────────────────────────────────────────────────────┘  │
│  ↑ 首次解析创建                              容器销毁 ↑    │
│                                                             │
│  Scoped (作用域1):                                          │
│  ┌────────────────────────┐                                │
│  │████████████████████████│                                │
│  └────────────────────────┘                                │
│  ↑ 作用域创建        作用域销毁 ↑                          │
│                                                             │
│  Scoped (作用域2):                                          │
│            ┌────────────────────────┐                      │
│            │████████████████████████│                      │
│            └────────────────────────┘                      │
│            ↑ 作用域创建        作用域销毁 ↑                │
│                                                             │
│  Transient:                                                 │
│  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐               │
│  │██│  │██│  │██│  │██│  │██│  │██│  │██│               │
│  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘               │
│  ↑每次解析创建新实例                                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.4 IDisposable 支持

框架自动管理实现 IDisposable 接口的对象：

```
┌─────────────────────────────────────────────────────────────┐
│                    IDisposable 管理                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Singleton:                                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  容器销毁时自动调用 Dispose()                        │   │
│  │  按注册的逆序销毁                                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  Scoped:                                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  作用域销毁时自动调用 Dispose()                      │   │
│  │  按创建的逆序销毁                                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  Transient:                                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  容器不跟踪，调用者负责调用 Dispose()                │   │
│  │  可选：注册时指定由容器跟踪                          │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.5 生命周期验证

框架提供生命周期验证，防止常见的生命周期错误：

| 验证规则 | 描述 | 错误示例 |
|----------|------|----------|
| 作用域捕获 | Singleton 不能依赖 Scoped | Singleton 服务注入 Scoped 服务 |
| 瞬态捕获 | Singleton/Scoped 不能直接依赖 Transient | 单例服务持有瞬态引用 |
| 循环依赖 | 检测并报告循环依赖 | A → B → C → A |

```
┌─────────────────────────────────────────────────────────────┐
│                    生命周期验证规则                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  允许的依赖方向：                                            │
│                                                             │
│  Transient ──▶ Scoped ──▶ Singleton                        │
│       │           │            │                            │
│       │           │            │                            │
│       ▼           ▼            ▼                            │
│  Transient    Scoped      Singleton                        │
│                                                             │
│  禁止的依赖方向：                                            │
│                                                             │
│  Singleton ──✗──▶ Scoped                                   │
│  Singleton ──✗──▶ Transient (直接持有)                     │
│  Scoped ────✗──▶ Transient (直接持有)                      │
│                                                             │
│  解决方案：                                                  │
│  - 使用 Func<T> 延迟解析                                    │
│  - 使用 Lazy<T> 延迟初始化                                  │
│  - 调整生命周期设计                                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```


---

## 6. 作用域系统

### 6.1 作用域概念

作用域（Scope）是容器的一个隔离边界，用于管理一组相关对象的生命周期。

```
┌─────────────────────────────────────────────────────────────┐
│                    作用域层次结构                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              根作用域 (Root Scope)                   │   │
│  │  ┌───────────────────────────────────────────────┐  │   │
│  │  │  - 应用程序级别                                │  │   │
│  │  │  - 管理全局 Singleton                          │  │   │
│  │  │  - 生命周期 = 应用程序生命周期                 │  │   │
│  │  └───────────────────────────────────────────────┘  │   │
│  └──────────────────────────┬──────────────────────────┘   │
│                             │                               │
│              ┌──────────────┴──────────────┐                │
│              ▼                             ▼                │
│  ┌─────────────────────┐     ┌─────────────────────┐       │
│  │ 场景作用域A         │     │ 场景作用域B         │       │
│  │ (Scene Scope)       │     │ (Scene Scope)       │       │
│  │  ┌───────────────┐  │     │  ┌───────────────┐  │       │
│  │  │ - 场景级别    │  │     │  │ - 场景级别    │  │       │
│  │  │ - 管理 Scoped │  │     │  │ - 管理 Scoped │  │       │
│  │  │ - 场景卸载销毁│  │     │  │ - 场景卸载销毁│  │       │
│  │  └───────────────┘  │     │  └───────────────┘  │       │
│  └──────────┬──────────┘     └─────────────────────┘       │
│             │                                               │
│             ▼                                               │
│  ┌─────────────────────┐                                   │
│  │ 子作用域            │                                   │
│  │ (Child Scope)       │                                   │
│  │  ┌───────────────┐  │                                   │
│  │  │ - 临时作用域  │  │                                   │
│  │  │ - UI面板级别  │  │                                   │
│  │  │ - 手动销毁    │  │                                   │
│  │  └───────────────┘  │                                   │
│  └─────────────────────┘                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 作用域解析规则

```
┌─────────────────────────────────────────────────────────────┐
│                    作用域解析流程                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  解析请求                                                    │
│      │                                                      │
│      ▼                                                      │
│  ┌─────────────┐                                           │
│  │ 当前作用域  │                                           │
│  │ 查找注册    │                                           │
│  └──────┬──────┘                                           │
│         │                                                   │
│         │ 未找到                                            │
│         ▼                                                   │
│  ┌─────────────┐                                           │
│  │ 父作用域    │                                           │
│  │ 查找注册    │                                           │
│  └──────┬──────┘                                           │
│         │                                                   │
│         │ 未找到                                            │
│         ▼                                                   │
│  ┌─────────────┐                                           │
│  │ 根作用域    │                                           │
│  │ 查找注册    │                                           │
│  └──────┬──────┘                                           │
│         │                                                   │
│         │ 未找到                                            │
│         ▼                                                   │
│  ┌─────────────┐                                           │
│  │ 抛出异常    │                                           │
│  │ 或返回null  │                                           │
│  └─────────────┘                                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 作用域实例管理

| 生命周期 | 实例存储位置 | 解析行为 |
|----------|--------------|----------|
| Singleton | 根作用域 | 始终从根作用域获取 |
| Scoped | 当前作用域 | 从当前作用域获取或创建 |
| Transient | 不存储 | 每次创建新实例 |

```
┌─────────────────────────────────────────────────────────────┐
│                    实例存储示意                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  根作用域实例缓存：                                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  IConfigService → ConfigService (Singleton)          │   │
│  │  ILogService → LogService (Singleton)                │   │
│  │  IEventBus → EventBus (Singleton)                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  场景作用域A实例缓存：                                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  IResourceManager → ResourceManager (Scoped)         │   │
│  │  IUIManager → UIManager (Scoped)                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  场景作用域B实例缓存：                                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  IResourceManager → ResourceManager' (Scoped)        │   │
│  │  IUIManager → UIManager' (Scoped)                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  注：场景A和场景B的 Scoped 服务是不同的实例                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.4 作用域生命周期

```
┌─────────────────────────────────────────────────────────────┐
│                    作用域生命周期                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐  │
│  │ 创建    │───▶│ 激活    │───▶│ 使用中  │───▶│ 销毁    │  │
│  │ Create  │    │ Activate│    │ Active  │    │ Dispose │  │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘  │
│       │              │              │              │        │
│       │              │              │              │        │
│       ▼              ▼              ▼              ▼        │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐  │
│  │构建容器 │    │执行入口 │    │解析服务 │    │销毁实例 │  │
│  │注册服务 │    │点初始化 │    │处理请求 │    │释放资源 │  │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.5 作用域使用场景

| 场景 | 作用域类型 | 说明 |
|------|------------|------|
| 游戏启动 | 根作用域 | 全局服务初始化 |
| 场景加载 | 场景作用域 | 场景级服务初始化 |
| UI面板打开 | 子作用域 | 面板级服务隔离 |
| 战斗开始 | 子作用域 | 战斗系统服务隔离 |
| 网络请求 | 临时作用域 | 请求级服务隔离 |

---

## 7. Unity 集成

### 7.1 LifetimeScope 组件

LifetimeScope 是 AFramework.DI 与 Unity 集成的核心组件，作为场景中的容器管理器。

```
┌─────────────────────────────────────────────────────────────┐
│                    LifetimeScope 架构                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              LifetimeScope (MonoBehaviour)           │   │
│  │  ┌───────────────────────────────────────────────┐  │   │
│  │  │  核心功能：                                    │  │   │
│  │  │  - 容器生命周期管理                           │  │   │
│  │  │  - 父子关系维护                               │  │   │
│  │  │  - 自动构建触发                               │  │   │
│  │  │  - 场景卸载时自动销毁                         │  │   │
│  │  └───────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           │ 包含                            │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Container (容器实例)                    │   │
│  │  ┌───────────────────────────────────────────────┐  │   │
│  │  │  - 服务注册表                                  │  │   │
│  │  │  - 实例缓存                                    │  │   │
│  │  │  - 解析器                                      │  │   │
│  │  └───────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 7.2 LifetimeScope 配置选项

| 选项 | 类型 | 描述 |
|------|------|------|
| Parent | LifetimeScope | 父作用域引用 |
| AutoRun | bool | 是否在 Awake 时自动构建 |
| ParentReference | ParentReference | 父容器查找方式 |
| Installers | IInstaller[] | 安装器列表 |

### 7.3 父容器查找方式

```
┌─────────────────────────────────────────────────────────────┐
│                    父容器查找方式                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ParentReference.Auto                                │   │
│  │  - 自动查找场景中的父 LifetimeScope                  │   │
│  │  - 按层级向上查找                                    │   │
│  │  - 找不到则使用根容器                                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ParentReference.Direct                              │   │
│  │  - 直接引用指定的 LifetimeScope                      │   │
│  │  - 通过 Inspector 拖拽设置                           │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ParentReference.ByType<T>                           │   │
│  │  - 按类型查找父 LifetimeScope                        │   │
│  │  - 适合跨场景引用                                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ParentReference.None                                │   │
│  │  - 不设置父容器                                      │   │
│  │  - 作为独立的根容器                                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 7.4 组件注册方式

```
┌─────────────────────────────────────────────────────────────┐
│                    Unity 组件注册方式                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  方式1：注册现有组件实例                                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  RegisterComponent(existingComponent)                │   │
│  │  - 注册场景中已存在的组件                            │   │
│  │  - 组件生命周期由 Unity 管理                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  方式2：在层级中查找组件                                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  RegisterComponentInHierarchy<T>()                   │   │
│  │  - 在 LifetimeScope 的子层级中查找                   │   │
│  │  - 自动查找并注册                                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  方式3：在新 GameObject 上创建                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  RegisterComponentOnNewGameObject<T>()               │   │
│  │  - 创建新的 GameObject                               │   │
│  │  - 添加指定组件                                      │   │
│  │  - 容器销毁时 GameObject 被销毁                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  方式4：从预制体实例化                                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  RegisterComponentFromPrefab<T>(prefab)              │   │
│  │  - 从预制体实例化 GameObject                         │   │
│  │  - 获取指定组件并注册                                │   │
│  │  - 支持依赖注入到实例化的组件                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 7.5 GameObject 注入

```
┌─────────────────────────────────────────────────────────────┐
│                    GameObject 注入流程                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐                                           │
│  │ GameObject  │                                           │
│  │  ├─ ComponentA ([Inject] 标记)                          │
│  │  ├─ ComponentB ([Inject] 标记)                          │
│  │  └─ Child                                               │
│  │      └─ ComponentC ([Inject] 标记)                      │
│  └──────┬──────┘                                           │
│         │                                                   │
│         │ InjectGameObject(gameObject)                     │
│         ▼                                                   │
│  ┌─────────────┐                                           │
│  │  容器       │                                           │
│  │  - 遍历所有 MonoBehaviour                               │
│  │  - 查找 [Inject] 标记的成员                             │
│  │  - 解析并注入依赖                                       │
│  └─────────────┘                                           │
│         │                                                   │
│         │ 注入完成                                          │
│         ▼                                                   │
│  ┌─────────────┐                                           │
│  │ GameObject  │                                           │
│  │  ├─ ComponentA (已注入)                                 │
│  │  ├─ ComponentB (已注入)                                 │
│  │  └─ Child                                               │
│  │      └─ ComponentC (已注入)                             │
│  └─────────────┘                                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 7.6 Prefab 实例化增强

```
┌─────────────────────────────────────────────────────────────┐
│                    Prefab 实例化增强                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  标准 Unity 实例化：                                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Instantiate(prefab)                                 │   │
│  │  - 创建实例                                          │   │
│  │  - 无依赖注入                                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  AFramework.DI 增强实例化：                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  container.Instantiate(prefab)                       │   │
│  │  - 创建实例                                          │   │
│  │  - 自动注入所有 [Inject] 标记的依赖                  │   │
│  │  - 支持位置、旋转、父对象参数                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  支持的重载：                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Instantiate(prefab)                                 │   │
│  │  Instantiate(prefab, parent)                         │   │
│  │  Instantiate(prefab, position, rotation)             │   │
│  │  Instantiate(prefab, position, rotation, parent)     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 7.7 场景生命周期集成

```
┌─────────────────────────────────────────────────────────────┐
│                    场景生命周期集成                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  场景加载流程：                                              │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐  │
│  │ 场景    │───▶│Lifetime │───▶│ 容器    │───▶│ 入口点  │  │
│  │ 加载    │    │ Scope   │    │ 构建    │    │ 执行    │  │
│  │         │    │ Awake   │    │         │    │         │  │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘  │
│                                                             │
│  场景卸载流程：                                              │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐  │
│  │ 场景    │───▶│Lifetime │───▶│ 容器    │───▶│ 实例    │  │
│  │ 卸载    │    │ Scope   │    │ 销毁    │    │ Dispose │  │
│  │         │    │OnDestroy│    │         │    │         │  │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘  │
│                                                             │
│  DontDestroyOnLoad 支持：                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  - 根 LifetimeScope 可标记为 DontDestroyOnLoad       │   │
│  │  - 跨场景保持容器和服务                              │   │
│  │  - 子场景容器自动查找并关联                          │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```


---

## 8. 注册系统

### 8.1 注册 API 概述

```
┌─────────────────────────────────────────────────────────────┐
│                    注册 API 层次                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              IContainerBuilder                       │   │
│  │  ┌───────────────────────────────────────────────┐  │   │
│  │  │  Register<T>()           // 类型注册          │  │   │
│  │  │  Register<TInterface, TImpl>() // 接口绑定   │  │   │
│  │  │  RegisterInstance<T>()   // 实例注册          │  │   │
│  │  │  RegisterFactory<T>()    // 工厂注册          │  │   │
│  │  │  UseInstaller<T>()       // 安装器            │  │   │
│  │  └───────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           │ 返回                            │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              IRegistrationBuilder                    │   │
│  │  ┌───────────────────────────────────────────────┐  │   │
│  │  │  As<TInterface>()        // 接口映射          │  │   │
│  │  │  AsSelf()                // 自身类型          │  │   │
│  │  │  AsImplementedInterfaces() // 所有接口        │  │   │
│  │  │  Singleton()             // 单例生命周期      │  │   │
│  │  │  Scoped()                // 作用域生命周期    │  │   │
│  │  │  Transient()             // 瞬态生命周期      │  │   │
│  │  │  WithParameter()         // 参数注入          │  │   │
│  │  │  Keyed()                 // 键值注册          │  │   │
│  │  └───────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 8.2 类型注册

```
┌─────────────────────────────────────────────────────────────┐
│                    类型注册方式                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  基础类型注册：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Register<ServiceA>()                                │   │
│  │  - 注册具体类型                                      │   │
│  │  - 默认 Transient 生命周期                           │   │
│  │  - 可通过 AsSelf() 解析                              │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  接口绑定注册：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Register<IService, ServiceImpl>()                   │   │
│  │  - 注册接口到实现的映射                              │   │
│  │  - 通过接口类型解析                                  │   │
│  │  - 支持多实现注册                                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  多接口注册：                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Register<ServiceImpl>()                             │   │
│  │      .As<IServiceA>()                                │   │
│  │      .As<IServiceB>()                                │   │
│  │  - 一个实现注册为多个接口                            │   │
│  │  - 所有接口解析返回同一实例（Singleton时）           │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  自动接口注册：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Register<ServiceImpl>()                             │   │
│  │      .AsImplementedInterfaces()                      │   │
│  │  - 自动注册为所有实现的接口                          │   │
│  │  - 排除系统接口（IDisposable等）                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 8.3 实例注册

```
┌─────────────────────────────────────────────────────────────┐
│                    实例注册方式                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  直接实例注册：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  RegisterInstance(existingInstance)                  │   │
│  │  - 注册已创建的实例                                  │   │
│  │  - 始终为 Singleton 生命周期                         │   │
│  │  - 容器不负责创建，但负责销毁（如实现IDisposable）   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  泛型实例注册：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  RegisterInstance<IService>(existingInstance)        │   │
│  │  - 指定注册的服务类型                                │   │
│  │  - 实例类型必须兼容服务类型                          │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  外部管理实例：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  RegisterInstance(instance).ExternallyOwned()        │   │
│  │  - 容器不负责销毁实例                                │   │
│  │  - 适合外部系统管理的对象                            │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 8.4 工厂注册

```
┌─────────────────────────────────────────────────────────────┐
│                    工厂注册方式                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  简单工厂：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  RegisterFactory<IService>(() => new ServiceImpl())  │   │
│  │  - 通过委托创建实例                                  │   │
│  │  - 每次解析调用工厂函数                              │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  带容器访问的工厂：                                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  RegisterFactory<IService>(resolver => {             │   │
│  │      var dep = resolver.Resolve<IDependency>();      │   │
│  │      return new ServiceImpl(dep);                    │   │
│  │  })                                                  │   │
│  │  - 工厂函数可访问容器                                │   │
│  │  - 可解析其他依赖                                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  Func<T> 注入：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  // 自动支持 Func<T> 注入                            │   │
│  │  // 消费者可注入 Func<IService>                      │   │
│  │  // 调用时创建新实例                                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  Lazy<T> 注入：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  // 自动支持 Lazy<T> 注入                            │   │
│  │  // 首次访问 Value 时创建实例                        │   │
│  │  // 后续访问返回同一实例                             │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 8.5 泛型注册

```
┌─────────────────────────────────────────────────────────────┐
│                    泛型注册支持                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  开放泛型注册：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Register(typeof(IRepository<>), typeof(Repository<>))│   │
│  │  - 注册开放泛型类型                                  │   │
│  │  - 解析时自动构造封闭泛型                            │   │
│  │  - 示例：Resolve<IRepository<User>>()               │   │
│  │         → 返回 Repository<User> 实例                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  封闭泛型注册：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Register<IRepository<User>, UserRepository>()       │   │
│  │  - 注册特定泛型参数的实现                            │   │
│  │  - 优先级高于开放泛型                                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  泛型约束支持：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  - 支持 where T : class                              │   │
│  │  - 支持 where T : struct                             │   │
│  │  - 支持 where T : new()                              │   │
│  │  - 支持 where T : IInterface                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 8.6 集合注册

```
┌─────────────────────────────────────────────────────────────┐
│                    集合注册与解析                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  多实现注册：                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Register<IHandler, HandlerA>()                      │   │
│  │  Register<IHandler, HandlerB>()                      │   │
│  │  Register<IHandler, HandlerC>()                      │   │
│  │  - 同一接口注册多个实现                              │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  集合解析：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  // 注入 IEnumerable<IHandler>                       │   │
│  │  // 返回所有注册的 IHandler 实现                     │   │
│  │  // 按注册顺序排列                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  数组解析：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  // 注入 IHandler[]                                  │   │
│  │  // 返回所有注册的 IHandler 实现数组                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  单一解析（最后注册）：                                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  // 注入 IHandler                                    │   │
│  │  // 返回最后注册的实现                               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 8.7 条件注册

```
┌─────────────────────────────────────────────────────────────┐
│                    条件注册                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  条件注册：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Register<IService, ServiceImpl>()                   │   │
│  │      .When(context => context.IsEditor)              │   │
│  │  - 根据条件决定是否激活注册                          │   │
│  │  - 条件在解析时评估                                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  平台条件：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Register<IService, MobileService>()                 │   │
│  │      .WhenPlatform(RuntimePlatform.Android)          │   │
│  │  Register<IService, DesktopService>()                │   │
│  │      .WhenPlatform(RuntimePlatform.WindowsPlayer)    │   │
│  │  - 根据运行平台选择实现                              │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  配置条件：                                                  │
│  ���─────────────────────────────────────────────────────┐   │
│  │  Register<IService, DebugService>()                  │   │
│  │      .WhenConfig("Debug", true)                      │   │
│  │  - 根据配置值决定注册                                │   │
│  │  - 与 AFramework.Config 集成                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 9. 解析系统

### 9.1 解析 API

```
┌─────────────────────────────────────────────────────────────┐
│                    解析 API                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              IObjectResolver                         │   │
│  │  ┌───────────────────────────────────────────────┐  │   │
│  │  │  Resolve<T>()            // 必需解析          │  │   │
│  │  │  ResolveOrDefault<T>()   // 可选解析          │  │   │
│  │  │  ResolveAll<T>()         // 集合解析          │  │   │
│  │  │  TryResolve<T>()         // 尝试解析          │  │   │
│  │  │  Inject(instance)        // 注入现有实例      │  │   │
│  │  │  Instantiate(prefab)     // 实例化并注入      │  │   │
│  │  └───────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 9.2 解析流程

```
┌─────────────────────────────────────────────────────────────┐
│                    解析流程详解                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐                                           │
│  │ Resolve<T>()│                                           │
│  └──────┬──────┘                                           │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────┐    否     ┌─────────────┐                 │
│  │ 查找注册    │──────────▶│ 抛出异常    │                 │
│  │ Registry    │           │ 或返回null  │                 │
│  └──────┬──────┘           └─────────────┘                 │
│         │ 是                                                │
│         ▼                                                   │
│  ┌─────────────┐                                           │
│  │ 检查生命周期│                                           │
│  └──────┬──────┘                                           │
│         │                                                   │
│    ┌────┴────┬────────────┐                                │
│    ▼         ▼            ▼                                │
│ Singleton  Scoped    Transient                             │
│    │         │            │                                │
│    ▼         ▼            ▼                                │
│ ┌──────┐ ┌──────┐    ┌──────┐                             │
│ │检查  │ │检查  │    │创建  │                             │
│ │缓存  │ │缓存  │    │新实例│                             │
│ └──┬───┘ └──┬───┘    └──┬───┘                             │
│    │        │           │                                  │
│    ▼        ▼           │                                  │
│ 命中?    命中?          │                                  │
│ ┌──┴──┐ ┌──┴──┐        │                                  │
│ │是│否│ │是│否│        │                                  │
│ └┬─┴┬─┘ └┬─┴┬─┘        │                                  │
│  │  │    │  │          │                                  │
│  │  ▼    │  ▼          │                                  │
│  │创建   │创建         │                                  │
│  │并缓存 │并缓存       │                                  │
│  │  │    │  │          │                                  │
│  ▼  ▼    ▼  ▼          ▼                                  │
│  └──┴────┴──┴──────────┘                                  │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────┐                                           │
│  │ 执行注入    │                                           │
│  │ (属性/方法) │                                           │
│  └──────┬──────┘                                           │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────┐                                           │
│  │ 返回实例    │                                           │
│  └─────────────┘                                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 9.3 循环依赖检测

```
┌─────────────────────────────────────────────────────────────┐
│                    循环依赖检测                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  循环依赖示例：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ServiceA → ServiceB → ServiceC → ServiceA          │   │
│  │      ↑                               │              │   │
│  │      └───────────────────────────────┘              │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  检测机制：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  1. 解析时维护调用栈                                 │   │
│  │  2. 每次解析前检查类型是否在栈中                     │   │
│  │  3. 发现循环时抛出详细异常                           │   │
│  │  4. 异常包含完整的依赖链信息                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  解决方案：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  方案1：使用属性注入打破循环                         │   │
│  │  - 将其中一个依赖改为属性注入                        │   │
│  │  - 属性注入在构造后执行                              │   │
│  │                                                      │   │
│  │  方案2：使用 Lazy<T> 延迟解析                        │   │
│  │  - 注入 Lazy<T> 而非 T                               │   │
│  │  - 首次访问 Value 时才解析                           │   │
│  │                                                      │   │
│  │  方案3：使用 Func<T> 工厂                            │   │
│  │  - 注入 Func<T> 而非 T                               │   │
│  │  - 需要时调用工厂获取实例                            │   │
│  │                                                      │   │
│  │  方案4：重构设计                                     │   │
│  │  - 提取公共依赖到第三个服务                          │   │
│  │  - 使用事件/消息解耦                                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 9.4 可选依赖处理

```
┌─────────────────────────────────────────────────────────────┐
│                    可选依赖处理                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [Optional] 特性：                                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  [Inject]                                            │   │
│  │  [Optional]                                          │   │
│  │  private IOptionalService _service;                  │   │
│  │  - 未注册时不抛异常                                  │   │
│  │  - 字段/属性保持 null                                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ResolveOrDefault<T>()：                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  var service = container.ResolveOrDefault<IService>()│   │
│  │  - 未注册时返回 default(T)                           │   │
│  │  - 引用类型返回 null                                 │   │
│  │  - 值类型返回默认值                                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  TryResolve<T>()：                                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  if (container.TryResolve<IService>(out var service))│   │
│  │  {                                                   │   │
│  │      // 使用 service                                 │   │
│  │  }                                                   │   │
│  │  - 返回 bool 表示是否成功                            │   │
│  │  - out 参数返回实例                                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```


---

## 10. 入口点系统

### 10.1 入口点概述

入口点系统提供了一系列接口，用于在 Unity 生命周期的特定时机自动执行代码，无需手动创建 MonoBehaviour。

```
┌─────────────────────────────────────────────────────────────┐
│                    入口点接口一览                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  初始化阶段：                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  IInitializable        - 容器构建后立即调用          │   │
│  │  IPostInitializable    - 所有 IInitializable 后调用  │   │
│  │  IAsyncStartable       - 异步启动（支持 UniTask）    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  启动阶段：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  IStartable            - Unity Start 时调用          │   │
│  │  IPostStartable        - 所有 IStartable 后调用      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  更新阶段：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ITickable             - 每帧 Update 时调用          │   │
│  │  IPostTickable         - 所有 ITickable 后调用       │   │
│  │  IFixedTickable        - FixedUpdate 时调用          │   │
│  │  IPostFixedTickable    - 所有 IFixedTickable 后调用  │   │
│  │  ILateTickable         - LateUpdate 时调用           │   │
│  │  IPostLateTickable     - 所有 ILateTickable 后调用   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 10.2 入口点执行顺序

```
┌─────────────────────────────────────────────────────────────┐
│                    入口点执行时序                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  容器构建完成                                                │
│       │                                                     │
│       ▼                                                     │
│  ┌─────────────┐                                           │
│  │IInitializable│ ← 同步初始化                              │
│  │ Initialize() │                                          │
│  └──────┬──────┘                                           │
│         ▼                                                   │
│  ┌─────────────────┐                                       │
│  │IPostInitializable│                                       │
│  │ PostInitialize() │                                       │
│  └──────┬──────────┘                                       │
│         ▼                                                   │
│  ┌─────────────────┐                                       │
│  │ IAsyncStartable │ ← 异步启动（可等待）                   │
│  │ StartAsync()    │                                       │
│  └──────┬──────────┘                                       │
│         │                                                   │
│  ═══════╪═══════════ Unity Start ═══════════════════════   │
│         ▼                                                   │
│  ┌─────────────┐                                           │
│  │ IStartable  │                                           │
│  │ Start()     │                                           │
│  └──────┬──────┘                                           │
│         ▼                                                   │
│  ┌───────────────┐                                         │
│  │IPostStartable │                                         │
│  │ PostStart()   │                                         │
│  └──────┬────────┘                                         │
│         │                                                   │
│  ═══════╪═══════════ 每帧循环 ══════════════════════════   │
│         ▼                                                   │
│  ┌─────────────┐ → ┌───────────────┐                       │
│  │ ITickable   │   │ IPostTickable │                       │
│  │ Tick()      │   │ PostTick()    │                       │
│  └─────────────┘   └───────────────┘                       │
│         │                                                   │
│  ═══════╪═══════════ FixedUpdate ═══════════════════════   │
│         ▼                                                   │
│  ┌───────────────┐ → ┌─────────────────┐                   │
│  │IFixedTickable │   │IPostFixedTickable│                   │
│  │ FixedTick()   │   │ PostFixedTick() │                   │
│  └───────────────┘   └─────────────────┘                   │
│         │                                                   │
│  ═══════╪═══════════ LateUpdate ════════════════════════   │
│         ▼                                                   │
│  ┌──────────────┐ → ┌────────────────┐                     │
│  │ILateTickable │   │IPostLateTickable│                     │
│  │ LateTick()   │   │ PostLateTick() │                     │
│  └──────────────┘   └────────────────┘                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 10.3 入口点注册

```
┌─────────────────────────────────────────────────────────────┐
│                    入口点注册方式                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  自动注册（推荐）：                                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Register<GameManager>()                             │   │
│  │      .AsImplementedInterfaces()                      │   │
│  │      .Singleton();                                   │   │
│  │  - 实现入口点接口的类自动注册                        │   │
│  │  - 无需额外配置                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  显式注册：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  RegisterEntryPoint<GameManager>()                   │   │
│  │  - 明确注册为入口点                                  │   │
│  │  - 自动识别实现的入口点接口                          │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  执行顺序控制：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  RegisterEntryPoint<ServiceA>().Order(100);          │   │
│  │  RegisterEntryPoint<ServiceB>().Order(200);          │   │
│  │  - 数值小的先执行                                    │   │
│  │  - 默认顺序为 0                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 10.4 异步启动支持

```
┌─────────────────────────────────────────────────────────────┐
│                    异步启动 (IAsyncStartable)                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  UniTask 集成：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  public class ResourceLoader : IAsyncStartable       │   │
│  │  {                                                   │   │
│  │      public async UniTask StartAsync(CancellationToken ct)│
│  │      {                                               │   │
│  │          await LoadResourcesAsync();                 │   │
│  │          await InitializeSystemsAsync();             │   │
│  │      }                                               │   │
│  │  }                                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  特点：                                                      │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  - 支持 CancellationToken 取消                       │   │
│  │  - 容器销毁时自动取消                                │   │
│  │  - 可配置是否等待完成后再执行 IStartable             │   │
│  │  - 异常会被捕获并记录                                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 10.5 入口点使用场景

| 接口 | 使用场景 |
|------|----------|
| IInitializable | 服务初始化、依赖检查、配置加载 |
| IAsyncStartable | 资源预加载、网络连接、数据库初始化 |
| IStartable | 游戏逻辑启动、UI初始化 |
| ITickable | 游戏主循环、输入处理、AI更新 |
| IFixedTickable | 物理模拟、网络同步 |
| ILateTickable | 相机跟随、UI更新、动画后处理 |

---

## 11. 诊断系统

### 11.1 诊断功能概述

```
┌─────────────────────────────────────────────────────────────┐
│                    诊断系统架构                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              DiagnosticsCollector                    │   │
│  │  ┌───────────────────────────────────────────────┐  │   │
│  │  │  - 注册信息收集                                │  │   │
│  │  │  - 解析路径追踪                                │  │   │
│  │  │  - 依赖关系分析                                │  │   │
│  │  │  - 性能指标统计                                │  │   │
│  │  └───────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              诊断窗口 (Editor)                       │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │ 注册列表    │ │ 依赖图      │ │ 性能分析    │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 11.2 诊断信息类型

| 信息类型 | 描述 |
|----------|------|
| 注册信息 | 所有注册的类型、接口、生命周期 |
| 依赖关系 | 类型间的依赖关系图 |
| 解析路径 | 解析请求的完整调用链 |
| 实例引用 | 已创建实例的引用信息 |
| 注册位置 | 注册代码的堆栈跟踪 |
| 性能指标 | 解析耗时、实例创建次数 |

### 11.3 诊断窗口功能

```
┌─────────────────────────────────────────────────────────────┐
│                    诊断窗口功能                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  注册列表视图：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │ 类型           │ 接口        │ 生命周期     │    │   │
│  │  ├─────────────────────────────────────────────┤    │   │
│  │  │ GameManager    │ IGameManager│ Singleton    │    │   │
│  │  │ PlayerService  │ IPlayer     │ Scoped       │    │   │
│  │  │ EnemyFactory   │ IFactory    │ Transient    │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  依赖关系图：                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                      │   │
│  │      ┌─────────────┐                                │   │
│  │      │ GameManager │                                │   │
│  │      └──────┬──────┘                                │   │
│  │             │                                        │   │
│  │      ┌──────┴──────┐                                │   │
│  │      ▼             ▼                                │   │
│  │  ┌────────┐   ┌────────┐                            │   │
│  │  │IPlayer │   │IConfig │                            │   │
│  │  └────────┘   └────────┘                            │   │
│  │                                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  问题检测：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ⚠️ 循环依赖检测                                    │   │
│  │  ⚠️ 生命周期不匹配警告                              │   │
│  │  ⚠️ 未使用的注册                                    │   │
│  │  ⚠️ 缺失的依赖                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 11.4 与 AFramework.DebugLog 集成

```
┌─────────────────────────────────────────────────────────────┐
│                    DebugLog 集成                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  运行时诊断面板：                                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  DI 诊断面板 (IDebugPanel)                           │   │
│  │  ┌───────────────────────────────────────────────┐  │   │
│  │  │  - 实时容器状态                                │  │   │
│  │  │  - 作用域层次结构                              │  │   │
│  │  │  - 实例计数统计                                │  │   │
│  │  │  - 解析性能监控                                │  │   │
│  │  └───────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  日志输出：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  [DI] Container built: 42 registrations              │   │
│  │  [DI] Resolved: IGameManager → GameManager           │   │
│  │  [DI] Warning: Captive dependency detected           │   │
│  │  [DI] Scope disposed: SceneScope (15 instances)      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 12. 性能优化

### 12.1 性能优化策略

```
┌─────────────────────────────────────────────────────────────┐
│                    性能优化策略                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  反射缓存：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  - 构造函数信息缓存                                  │   │
│  │  - 注入成员信息缓存                                  │   │
│  │  - 类型元数据缓存                                    │   │
│  │  - 首次解析后后续解析零反射开销                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  内联优化：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  - 关键路径使用 AggressiveInlining                   │   │
│  │  - 减少方法调用开销                                  │   │
│  │  - 热路径代码优化                                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  零GC解析：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  - Singleton/Scoped 解析无分配                       │   │
│  │  - 使用 Span<T> 避免数组分配                         │   │
│  │  - 对象池复用临时对象                                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  并发安全：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  - 使用 ConcurrentDictionary                         │   │
│  │  - 无锁读取路径                                      │   │
│  │  - 细粒度锁定写入                                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 12.2 性能对比

| 操作 | 首次解析 | 后续解析 (Singleton) | 后续解析 (Transient) |
|------|----------|---------------------|---------------------|
| 简单类型 | ~1μs | ~50ns | ~200ns |
| 复杂依赖 (5层) | ~5μs | ~50ns | ~1μs |
| 集合解析 | ~2μs | ~100ns | ~500ns |

### 12.3 最佳实践建议

| 建议 | 说明 |
|------|------|
| 优先使用 Singleton | 减少实例创建开销 |
| 避免深层依赖 | 依赖层次不超过 5 层 |
| 预热关键服务 | 启动时解析关键服务 |
| 使用 Func<T> | 延迟解析非必需依赖 |
| 批量注册 | 使用 Installer 组织注册 |

---

## 13. 扩展机制

### 13.1 自定义实例提供者

```
┌─────────────────────────────────────────────────────────────┐
│                    自定义实例提供者                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  IInstanceProvider 接口：                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  public interface IInstanceProvider                  │   │
│  │  {                                                   │   │
│  │      object GetInstance(IObjectResolver resolver);   │   │
│  │      void DisposeInstance(object instance);          │   │
│  │  }                                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  使用场景：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  - 对象池集成                                        │   │
│  │  - 特殊初始化逻辑                                    │   │
│  │  - 外部系统对象获取                                  │   │
│  │  - 代理对象创建                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 13.2 自定义注入器

```
┌─────────────────────────────────────────────────────────────┐
│                    自定义注入器                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  IInjector 接口：                                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  public interface IInjector                          │   │
│  │  {                                                   │   │
│  │      void Inject(object instance, IObjectResolver r);│   │
│  │      object CreateInstance(IObjectResolver resolver);│   │
│  │  }                                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  使用场景：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  - 自定义注入逻辑                                    │   │
│  │  - 特殊构造方式                                      │   │
│  │  - 注入拦截和增强                                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 13.3 构建回调

```
┌─────────────────────────────────────────────────────────────┐
│                    构建回调机制                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  容器构建回调：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  builder.RegisterBuildCallback(container => {        │   │
│  │      // 容器构建完成后执行                           │   │
│  │      // 可用于额外初始化                             │   │
│  │  });                                                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  实例创建回调：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Register<Service>()                                 │   │
│  │      .OnActivated((instance, resolver) => {          │   │
│  │          // 实例创建后执行                           │   │
│  │      });                                             │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  销毁回调：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Register<Service>()                                 │   │
│  │      .OnDisposing(instance => {                      │   │
│  │          // 实例销毁前执行                           │   │
│  │      });                                             │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 13.4 Installer 模式

```
┌─────────────────────────────────────────────────────────────┐
│                    Installer 模式                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  IInstaller 接口：                                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  public interface IInstaller                         │   │
│  │  {                                                   │   │
│  │      void Install(IContainerBuilder builder);        │   │
│  │  }                                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  模块化安装器：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  public class GameInstaller : IInstaller             │   │
│  │  {                                                   │   │
│  │      public void Install(IContainerBuilder builder)  │   │
│  │      {                                               │   │
│  │          builder.Register<GameManager>().Singleton();│   │
│  │          builder.Register<PlayerService>().Scoped(); │   │
│  │      }                                               │   │
│  │  }                                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  使用安装器：                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  builder.UseInstaller<GameInstaller>();              │   │
│  │  builder.UseInstaller<UIInstaller>();                │   │
│  │  builder.UseInstaller<NetworkInstaller>();           │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  优点：                                                      │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  - 注册逻辑模块化                                    │   │
│  │  - 可复用的配置单元                                  │   │
│  │  - 便于测试和维护                                    │   │
│  │  - 支持条件安装                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```


---

## 14. 最佳实践

### 14.1 注入方式选择

| 场景 | 推荐方式 | 原因 |
|------|----------|------|
| 必需依赖 | 构造函数注入 | 确保依赖完整性，不可变 |
| 可选依赖 | 属性注入 + [Optional] | 允许依赖缺失 |
| MonoBehaviour | 字段/属性注入 | 无法使用构造函数 |
| 需要初始化逻辑 | 方法注入 | 注入时执行代码 |
| 循环依赖 | 属性注入或 Lazy<T> | 打破循环 |

### 14.2 生命周期选择

| 场景 | 推荐生命周期 | 原因 |
|------|--------------|------|
| 全局服务 | Singleton | 共享状态，避免重复创建 |
| 场景级服务 | Scoped | 场景隔离，场景卸载时销毁 |
| 无状态服务 | Transient | 每次新实例，无副作用 |
| 昂贵初始化 | Singleton | 避免重复初始化开销 |
| 请求级数据 | Scoped | 请求内共享，请求间隔离 |

### 14.3 设计原则

```
┌─────────────────────────────────────────────────────────────┐
│                    DI 设计原则                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 依赖接口而非实现                                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ✅ 注入 IPlayerService                              │   │
│  │  ❌ 注入 PlayerService                               │   │
│  │  - 便于测试和替换实现                                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  2. 保持依赖数量合理                                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ✅ 构造函数参数 ≤ 5 个                              │   │
│  │  ❌ 构造函数参数 > 7 个                              │   │
│  │  - 过多依赖说明类职责过重，需要拆分                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  3. 避免服务定位器反模式                                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ✅ 通过构造函数注入依赖                             │   │
│  │  ❌ 在方法内调用 container.Resolve<T>()              │   │
│  │  - 隐藏依赖关系，难以测试                            │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  4. 组合根集中配置                                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ✅ 所有注册在 LifetimeScope 中完成                  │   │
│  │  ❌ 业务代码中包含注册逻辑                           │   │
│  │  - 依赖配置集中管理，便于维护                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  5. 使用 Installer 组织注册                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ✅ 按模块创建 Installer                             │   │
│  │  ❌ 所有注册堆在一个方法中                           │   │
│  │  - 模块化、可复用、易测试                            │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 14.4 常见错误与解决

| 错误 | 原因 | 解决方案 |
|------|------|----------|
| 循环依赖异常 | A→B→A | 使用属性注入或 Lazy<T> |
| 作用域捕获 | Singleton 依赖 Scoped | 调整生命周期或使用 Func<T> |
| 解析失败 | 未注册类型 | 检查注册配置 |
| 多实例问题 | 期望单例但创建多个 | 检查生命周期配置 |
| 内存泄漏 | Scoped 服务未释放 | 确保作用域正确销毁 |

### 14.5 测试策略

```
┌─────────────────────────────────────────────────────────────┐
│                    测试策略                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  单元测试：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  - 直接 new 被测类，传入 Mock 依赖                   │   │
│  │  - 不使用容器，测试纯业务逻辑                        │   │
│  │  - 构造函数注入使 Mock 注入简单                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  集成测试：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  - 创建测试专用容器                                  │   │
│  │  - 注册真实服务和 Mock 服务混合                      │   │
│  │  - 测试服务间交互                                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  替换注册：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  // 测试时替换实现                                   │   │
│  │  builder.Register<IService, MockService>();          │   │
│  │  // 或使用实例                                       │   │
│  │  builder.RegisterInstance<IService>(mockInstance);   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 15. 与其他模块集成

### 15.1 与 AFramework.Pool 集成

```
┌─────────────────────────────────────────────────────────────┐
│                    Pool 模块集成                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  池化实例提供者：                                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Register<Enemy>()                                   │   │
│  │      .FromPool(poolConfig)                           │   │
│  │      .Transient();                                   │   │
│  │  - 从对象池获取实例                                  │   │
│  │  - 释放时归还池而非销毁                              │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  池服务注册：                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Register<IObjectPool<Bullet>, BulletPool>()         │   │
│  │      .Singleton();                                   │   │
│  │  - 池本身作为服务注册                                │   │
│  │  - 其他服务可注入池                                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 15.2 与 AFramework.EventSystem 集成

```
┌─────────────────────────────────────────────────────────────┐
│                    EventSystem 集成                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  事件服务注册：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  // 注册事件总线                                     │   │
│  │  Register<IEventBus, EventBus>().Singleton();        │   │
│  │                                                      │   │
│  │  // 注册发布者/订阅者                                │   │
│  │  Register<IPublisher<GameEvent>>().FromEventBus();   │   │
│  │  Register<ISubscriber<GameEvent>>().FromEventBus();  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  自动订阅：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  // 实现 IEventHandler<T> 的服务自动订阅             │   │
│  │  Register<PlayerHandler>()                           │   │
│  │      .AsImplementedInterfaces()                      │   │
│  │      .Singleton();                                   │   │
│  │  - 容器构建时自动注册事件处理器                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 15.3 与 AFramework.ECS 集成

```
┌─────────────────────────────────────────────────────────────┐
│                    ECS 模块集成                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  World 注册：                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  RegisterWorld("GameWorld")                          │   │
│  │      .WithDefaultSystems()                           │   │
│  │      .Singleton();                                   │   │
│  │  - 注册 ECS World                                    │   │
│  │  - 自动管理 World 生命周期                           │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  System 注册：                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  RegisterSystem<MovementSystem>()                    │   │
│  │      .InGroup<SimulationSystemGroup>()               │   │
│  │      .Order(100);                                    │   │
│  │  - 注册 ECS System                                   │   │
│  │  - 支持依赖注入到 System                             │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  混合模式：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  // ECS System 可注入 DI 服务                        │   │
│  │  public partial class AISystem : SystemBase          │   │
│  │  {                                                   │   │
│  │      [Inject] private IConfigService _config;        │   │
│  │  }                                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 15.4 与 AFramework.ResourceSystem 集成

```
┌─────────────────────────────────────────────────────────────┐
│                    ResourceSystem 集成                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  资源服务注册：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Register<IResourceService, ResourceService>()       │   │
│  │      .Singleton();                                   │   │
│  │  - 资源管理服务作为单例                              │   │
│  │  - 全局共享资源缓存                                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  预制体实例化集成：                                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  // 资源加载 + 依赖注入                              │   │
│  │  var prefab = await resourceService.LoadAsync<GO>(); │   │
│  │  var instance = container.Instantiate(prefab);       │   │
│  │  - 加载预制体                                        │   │
│  │  - 实例化并自动注入依赖                              │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 15.5 与 UniTask/R3 集成

```
┌─────────────────────────────────────────────────────────────┐
│                    UniTask/R3 集成                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  UniTask 异步启动：                                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  public class Loader : IAsyncStartable               │   │
│  │  {                                                   │   │
│  │      public async UniTask StartAsync(CancellationToken ct)│
│  │      {                                               │   │
│  │          await UniTask.Delay(1000, cancellationToken: ct);│
│  │      }                                               │   │
│  │  }                                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  R3 响应式绑定：                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  // 注入 Observable 服务                             │   │
│  │  Register<IObservable<GameState>, GameStateObservable>()│
│  │      .Singleton();                                   │   │
│  │                                                      │   │
│  │  // 消费者订阅                                       │   │
│  │  _gameState.Subscribe(OnStateChanged)                │   │
│  │      .AddTo(destroyCancellationToken);               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 附录

### A. 特性一览表

| 特性 | 用途 | 目标 |
|------|------|------|
| [Inject] | 标记需要注入的成员 | 构造函数、方法、属性、字段 |
| [Key] | 指定键值注入 | 参数、属性、字段 |
| [Optional] | 标记可选依赖 | 参数、属性、字段 |
| [FromParent] | 从父容器解析 | 参数、属性、字段 |
| [Order] | 指定执行顺序 | 入口点类 |

### B. 接口一览表

| 接口 | 用途 |
|------|------|
| IContainerBuilder | 容器构建器 |
| IObjectResolver | 对象解析器 |
| IInstaller | 模块安装器 |
| IInstanceProvider | 实例提供者 |
| IInjector | 注入器 |
| IInitializable | 初始化入口点 |
| IStartable | 启动入口点 |
| ITickable | 更新入口点 |
| IAsyncStartable | 异步启动入口点 |

### C. 生命周期对照表

| 生命周期 | 实例数量 | 销毁时机 | 线程安全 |
|----------|----------|----------|----------|
| Singleton | 1 | 容器销毁 | 是 |
| Scoped | 每作用域1个 | 作用域销毁 | 是 |
| Transient | 每次解析新建 | 调用者负责 | 是 |

---

## 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0.0 | 2026-01 | 初始版本 |

---

> 文档结束
> 
> AFramework.DI - 高性能 Unity 依赖注入框架
> 
> 版权所有 © 2026 AFramework Team
