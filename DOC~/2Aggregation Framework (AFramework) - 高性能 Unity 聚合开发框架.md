## 5. 模块依赖关系

### 5.1 依赖层次图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           模块依赖层次图                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                        应用层 (Application)                        │ │
│  │  ┌─────────────────────────────────────────────────────────────┐  │ │
│  │  │                      游戏业务逻辑                            │  │ │
│  │  └─────────────────────────────────────────────────────────────┘  │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                    │                                    │
│                                    ▼                                    │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                        服务层 (Services)                           │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐    │ │
│  │  │Resource │ │ Event   │ │  Task   │ │AFramework│ │DebugLog │    │ │
│  │  │ System  │ │ System  │ │ System  │ │   DB    │ │         │    │ │
│  │  └────┬────┘ └────┬────┘ └────┬────┘ └────┬───┘ └────┬────┘    │ │
│  │       │           │           │           │          │          │ │
│  │  ┌────┴────┐ ┌────┴────┐ ┌────┴────┐ ┌────┴───┐               │ │
│  │  │ Config  │ │Localize │ │   ECS   │ │        │               │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └────────┘               │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                    │                                    │
│                                    ▼                                    │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                        核心层 (Core)                               │ │
│  │  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐     │ │
│  │  │       DI        │ │   Lifecycle     │ │  Module Manager │     │ │
│  │  └─────────────────┘ └─────────────────┘ └─────────────────┘     │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                    │                                    │
│                                    ▼                                    │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                        基础层 (Foundation)                         │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐    │ │
│  │  │  Pool   │ │Serialize│ │Algorithm│ │ CSharp  │ │ Unity   │    │ │
│  │  │         │ │  ation  │ │         │ │Extension│ │Extension│    │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘    │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                    │                                    │
│                                    ▼                                    │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                        外部依赖 (External)                         │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐    │ │
│  │  │ UniTask │ │   R3    │ │VContainer│ │MessagePipe│ │  Burst  │    │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘    │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐               │ │
│  │  │Entities │ │Addressables│ │MemoryPack│ │Collections│               │ │
│  │  │  1.43   │ │   1.28   │ │         │ │         │               │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘               │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 模块依赖矩阵

| 模块 | 依赖模块 | 可选依赖 |
|------|----------|----------|
| Pool | CSharpExtension | - |
| Localization | Config, Serialization | Addressables |
| ECS | DI, CSharpExtension | BurstExtension |
| Config | Serialization | Addressables |
| DebugLog | CSharpExtension, UnityExtension | - |
| CSharpExtension | - | - |
| UnityExtension | CSharpExtension | - |
| Algorithm | CSharpExtension | BurstExtension |
| Serialization | CSharpExtension | MemoryPack |
| DI | CSharpExtension | VContainer |
| BurstExtension | - | Unity.Burst 1.8.27 |
| Extension | CSharpExtension | UniTask, R3 |
| AFrameworkDB | Serialization, Config | MasterMemory |
| EventSystem | DI | MessagePipe |
| TaskSystem | EventSystem, Extension | UniTask |
| ResourceSystem | Config, Pool, Extension | Addressables 1.28 |

### 5.3 模块初始化顺序

```
┌─────────────────────────────────────────────────────────────┐
│                     模块初始化顺序                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  阶段1：基础层初始化                                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │CSharpExtension│→│   Pool    │→│Serialization│           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│                     │                                       │
│                     ▼                                       │
│  阶段2：核心层初始化                                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │     DI      │→│ Lifecycle  │→│   Module    │           │
│  │             │ │  Manager   │ │  Manager    │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│                     │                                       │
│                     ▼                                       │
│  阶段3：服务层初始化                                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │   Config    │→│Localization│→│ EventSystem │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│                     │                                       │
│                     ▼                                       │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ResourceSystem│→│AFrameworkDB│→│ TaskSystem  │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│                     │                                       │
│                     ▼                                       │
│  阶段4：可选模块初始化                                       │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │    ECS      │→│  DebugLog  │→│   其他      │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. 跨版本兼容策略

### 6.1 支持的 Unity 版本

| 版本 | 支持状态 | 备注 |
|------|----------|------|
| Unity 2022.3 LTS | ✅ 完全支持 | 主要开发版本 |
| Unity 2023.2 | ✅ 完全支持 | - |
| Unity 6000.0 (Unity 6) | ✅ 完全支持 | 新API适配 |
| Unity 6.1+ | ✅ 完全支持 | 持续更新 |

### 6.2 预处理指令定义

```
┌─────────────────────────────────────────────────────────────┐
│                     预处理指令体系                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  版本检测指令：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ UNITY_2022_3_OR_NEWER    // Unity 2022.3+           │   │
│  │ UNITY_2023_2_OR_NEWER    // Unity 2023.2+           │   │
│  │ UNITY_6000_0_OR_NEWER    // Unity 6.0+              │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  功能检测指令：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ AFRAMEWORK_UNITASK       // UniTask 已安装          │   │
│  │ AFRAMEWORK_R3            // R3 已安装               │   │

│  │ AFRAMEWORK_ENTITIES      // Entities 已安装         │   │
│  │ AFRAMEWORK_ADDRESSABLES  // Addressables 已安装     │   │
│  │ AFRAMEWORK_BURST         // Burst 已安装            │   │

│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  构建配置指令：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ AFRAMEWORK_DEBUG         // 调试模式                │   │
│  │ AFRAMEWORK_RELEASE       // 发布模式                │   │
│  │ AFRAMEWORK_PROFILING     // 性能分析模式            │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 API 兼容性处理

#### 6.3.1 版本适配层

```
┌─────────────────────────────────────────────────────────────┐
│                     版本适配层架构                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              统一 API 层                             │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │ AFramework.Compatibility                     │    │   │
│  │  │ - 提供统一的跨版本 API                       │    │   │
│  │  │ - 屏蔽底层版本差异                           │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│           ┌───────────────┼───────────────┐                 │
│           ▼               ▼               ▼                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ Unity 2022  │ │ Unity 2023  │ │ Unity 6.x   │           │
│  │ 适配实现    │ │ 适配实现    │ │ 适配实现    │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.4 包依赖版本管理

| 包名 | Unity 2022.3 | Unity 6.x | 备注 |
|------|--------------|-----------|------|
| com.unity.entities | 1.43.x | 1.43+ | ECS核心 |
| com.unity.burst | 1.8.x | 1.8.27+ | 编译优化 |
| com.unity.collections | 2.1.x | 2.4.x+ | 原生集合 |
| com.unity.mathematics | 1.2.x | 1.3.x+ | 数学库 |
| com.unity.addressables | 1.21.x | 1.28+ | 资源管理 |
| com.unity.serialization | 3.1.x | 3.1.x+ | 序列化 |


---

## 7. 性能优化策略

### 7.1 内存优化

#### 7.1.1 零GC分配策略

```
┌─────────────────────────────────────────────────────────────┐
│                     零GC分配策略                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  策略1：对象池化 (Pool模块)                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ - 所有频繁创建的对象使用Pool模块                     │   │
│  │ - 事件对象、消息对象、临时数据结构                   │   │
│  │ - 自动归还机制，防止泄漏                             │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  策略2：值类型优先                                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ - 小型数据结构使用 struct                            │   │
│  │ - 避免装箱拆箱操作                                   │   │
│  │ - 使用 in/ref/out 参数传递                          │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  策略3：缓冲区复用                                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ - 使用 ArrayPool<T> 租借数组                        │   │
│  │ - Serialization模块缓冲区池化                        │   │
│  │ - 字符串构建使用 StringBuilder 池                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  策略4：Span/Memory 使用                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ - 使用 Span<T> 避免数组复制                         │   │
│  │ - 使用 ReadOnlySpan<T> 传递只读数据                 │   │
│  │ - 字符串处理使用 ReadOnlySpan<char>                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 7.1.2 内存布局优化

| 优化项 | 描述 | 收益 |
|--------|------|------|
| 结构体对齐 | 字段按大小排序，减少填充 | 减少内存占用 |
| 数组连续 | 相关数据放在连续内存 | 提高缓存命中 |
| 热冷分离 | 频繁访问和不频繁访问数据分离 | 提高缓存效率 |
| 紧凑存储 | 使用位域、压缩格式 | 减少内存带宽 |

### 7.2 CPU 优化

#### 7.2.1 BurstExtension 编译优化

```
┌─────────────────────────────────────────────────────────────┐
│                BurstExtension 编译优化策略                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  优化级别：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Level 0: 无优化（调试用）                            │   │
│  │ Level 1: 基础优化                                    │   │
│  │ Level 2: 标准优化（默认）                            │   │
│  │ Level 3: 激进优化（发布版）                          │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  关键优化点：                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ - 循环向量化：使用 SIMD 指令并行处理                 │   │
│  │ - 内联展开：减少函数调用开销                         │   │
│  │ - 常量折叠：编译期计算常量表达式                     │   │
│  │ - 死代码消除：移除不可达代码                         │   │
│  │ - 别名分析：优化内存访问模式                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  最佳实践：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ - 使用 [BurstCompile] 标记热点代码                  │   │
│  │ - 避免托管类型和虚方法调用                           │   │
│  │ - 使用 Unity.Mathematics 类型                       │   │
│  │ - 使用 NativeContainer 替代托管集合                 │   │
│  │ - 标记 [NoAlias] 帮助编译器优化                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 7.2.2 Job System 并行化

```
┌─────────────────────────────────────────────────────────────┐
│                     Job System 并行化策略                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Job 类型选择：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ IJob              - 单一任务                         │   │
│  │ IJobParallelFor   - 数据并行（推荐）                 │   │
│  │ IJobParallelForBatch - 批量数据并行                  │   │
│  │ IJobFor           - 简化的并行循环                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  调度策略：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ - 合理设置 innerloopBatchCount                      │   │
│  │ - 避免过小的批次导致调度开销                         │   │
│  │ - 使用 JobHandle 管理依赖关系                       │   │
│  │ - 延迟 Complete() 调用，最大化并行                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 7.3 数据局部性优化 (ECS模块)

```
┌─────────────────────────────────────────────────────────────┐
│                     数据局部性优化                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ECS 数据布局：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                     │   │
│  │  传统 OOP (AoS - Array of Structures)               │   │
│  │  ┌────────────────────────────────────────────┐    │   │
│  │  │ Entity1: [Pos, Vel, HP, Name, ...]         │    │   │
│  │  │ Entity2: [Pos, Vel, HP, Name, ...]         │    │   │
│  │  │ Entity3: [Pos, Vel, HP, Name, ...]         │    │   │
│  │  └────────────────────────────────────────────┘    │   │
│  │  缓存效率低：遍历位置时加载无关数据                  │   │
│  │                                                     │   │
│  │  ECS DOD (SoA - Structure of Arrays)                │   │
│  │  ┌────────────────────────────────────────────┐    │   │
│  │  │ Positions: [Pos1, Pos2, Pos3, ...]         │    │   │
│  │  │ Velocities: [Vel1, Vel2, Vel3, ...]        │    │   │
│  │  │ HPs: [HP1, HP2, HP3, ...]                  │    │   │
│  │  └────────────────────────────────────────────┘    │   │
│  │  缓存效率高：连续访问同类型数据                      │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 7.4 性能监控指标

| 指标 | 目标值 | 监控方式 |
|------|--------|----------|
| 帧率 | ≥60 FPS | DebugLog模块 |
| 帧时间 | ≤16.67ms | Frame Debugger |
| GC分配 | 0 B/帧（热路径） | Memory Profiler |
| 内存占用 | 按平台预算 | Memory Profiler |
| DrawCall | ≤100（移动端） | Frame Debugger |
| 批处理率 | ≥90% | Statistics |

---

## 8. 扩展机制

### 8.1 模块扩展点

```
┌─────────────────────────────────────────────────────────────┐
│                     模块扩展点设计                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              扩展点类型                              │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │                                                     │   │
│  │  1. 接口扩展 (Interface Extension)                  │   │
│  │     ┌─────────────────────────────────────────┐    │   │
│  │     │ - 实现框架定义的接口                     │    │   │
│  │     │ - 通过 DI 容器注册自定义实现             │    │   │
│  │     │ - 例：ISerializer, IResourceLoader      │    │   │
│  │     └─────────────────────────────────────────┘    │   │
│  │                                                     │   │
│  │  2. 事件扩展 (EventSystem Extension)                │   │
│  │     ┌─────────────────────────────────────────┐    │   │
│  │     │ - 订阅框架发布的事件                     │    │   │
│  │     │ - 在事件处理中注入自定义逻辑             │    │   │
│  │     │ - 例：OnModuleInit, OnResourceLoaded    │    │   │
│  │     └─────────────────────────────────────────┘    │   │
│  │                                                     │   │
│  │  3. 管道扩展 (Pipeline Extension)                   │   │
│  │     ┌─────────────────────────────────────────┐    │   │
│  │     │ - 在处理管道中插入自定义步骤             │    │   │
│  │     │ - 支持前置/后置处理                      │    │   │
│  │     │ - 例：消息过滤器、序列化拦截器           │    │   │
│  │     └─────────────────────────────────────────┘    │   │
│  │                                                     │   │
│  │  4. 特性扩展 (Attribute Extension)                  │   │
│  │     ┌─────────────────────────────────────────┐    │   │
│  │     │ - 通过自定义特性标记扩展点               │    │   │
│  │     │ - 框架自动发现并处理                     │    │   │
│  │     │ - 例：[DebugPanel], [ConfigSection]     │    │   │
│  │     └─────────────────────────────────────────┘    │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 8.2 自定义模块开发

#### 8.2.1 模块接口定义

```
┌─────────────────────────────────────────────────────────────┐
│                     自定义模块接口                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  IModule 接口：                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ - Name: string              // 模块名称             │   │
│  │ - Priority: int             // 初始化优先级         │   │
│  │ - Dependencies: Type[]      // 依赖的其他模块       │   │
│  │ - OnRegister()              // 注册阶段             │   │
│  │ - OnInit()                  // 初始化阶段           │   │
│  │ - OnStart()                 // 启动阶段             │   │
│  │ - OnTick(deltaTime)         // 每帧更新             │   │
│  │ - OnStop()                  // 停止阶段             │   │
│  │ - OnDispose()               // 销毁阶段             │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  IConfigurableModule 接口（可选）：                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ - ConfigType: Type          // 配置类型             │   │
│  │ - Configure(config)         // 应用配置             │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 8.3 插件系统 (Extension模块)

#### 8.3.1 插件架构

```
┌─────────────────────────────────────────────────────────────┐
│            插件系统架构 (AFramework.Extension)               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              插件管理器 (PluginManager)              │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │ 插件发现    │ │ 插件加载    │ │ 插件卸载    │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              IPlugin 接口                            │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │ - PluginInfo: PluginMetadata                │    │   │
│  │  │ - OnLoad(IPluginContext)                    │    │   │
│  │  │ - OnUnload()                                │    │   │
│  │  │ - OnEnable()                                │    │   │
│  │  │ - OnDisable()                               │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│           ┌───────────────┼───────────────┐                 │
│           ▼               ▼               ▼                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ 内置插件    │ │ 用户插件    │ │ 第三方插件  │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 8.3.2 插件元数据

| 字段 | 类型 | 描述 |
|------|------|------|
| Id | string | 插件唯一标识 |
| Name | string | 插件显示名称 |
| Version | Version | 插件版本 |
| Author | string | 作者信息 |
| Description | string | 插件描述 |
| Dependencies | string[] | 依赖的其他插件 |
| MinFrameworkVersion | Version | 最低框架版本要求 |

### 8.4 源代码生成器扩展

```
┌─────────────────────────────────────────────────────────────┐
│                     源代码生成器扩展                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  内置生成器：                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ - AFrameworkDB 表生成器：根据数据定义生成表类       │   │
│  │ - Serialization格式化器生成器：自动生成序列化代码   │   │
│  │ - DI 注册生成器：自动发现并注册服务                 │   │
│  │ - EventSystem处理器生成器：自动生成事件订阅代码     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  自定义生成器接口：                                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ISourceGenerator                                    │   │
│  │ - Initialize(GeneratorInitializationContext)        │   │
│  │ - Execute(GeneratorExecutionContext)                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  生成器触发条件：                                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ - 特性标记：[GenerateXxx]                           │   │
│  │ - 接口实现：IXxxDefinition                          │   │
│  │ - 命名约定：XxxConfig, XxxTable                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```


---

## 9. 最佳实践

### 9.1 项目结构建议

```
┌─────────────────────────────────────────────────────────────┐
│                     推荐项目结构                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Assets/                                                    │
│  ├── _Project/                    // 项目专属内容           │
│  │   ├── Scripts/                                          │
│  │   │   ├── Core/                // 核心游戏逻辑          │
│  │   │   ├── Features/            // 功能模块              │
│  │   │   │   ├── Combat/                                   │
│  │   │   │   ├── Inventory/                                │
│  │   │   │   └── UI/                                       │
│  │   │   ├── Data/                // 数据定义              │
│  │   │   │   ├── Tables/          // AFrameworkDB 表定义   │
│  │   │   │   └── Configs/         // Config类定义          │
│  │   │   └── Generated/           // 生成代码（自动）      │
│  │   ├── Resources/               // Resources 资源        │
│  │   ├── Addressables/            // Addressables 资源     │
│  │   └── Localization/            // Localization资源      │
│  │                                                         │
│  ├── Plugins/                     // 第三方插件            │
│  │   ├── AFramework/              // 框架核心              │
│  │   ├── UniTask/                                          │
│  │   ├── R3/                                               │
│  │   └── ...                                               │
│  │                                                         │
│  └── StreamingAssets/             // 流式资源              │
│      ├── Configs/                 // Config配置文件        │
│      └── Data/                    // 数据文件              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 9.2 编码规范

#### 9.2.1 命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| 命名空间 | PascalCase，最多3层 | AFramework.EventSystem |
| 类/结构体 | PascalCase | PlayerController |
| 接口 | I + PascalCase | IResourceService |
| 方法 | PascalCase | LoadResourceAsync |
| 属性 | PascalCase | CurrentHealth |
| 字段（私有） | _camelCase | _playerData |
| 字段（公有） | PascalCase | MaxHealth |
| 参数 | camelCase | playerName |
| 常量 | UPPER_SNAKE_CASE | MAX_PLAYER_COUNT |
| 事件 | On + PascalCase | OnPlayerDeath |

#### 9.2.2 代码组织

```
┌─────────────────────────────────────────────────────────────┐
│                     代码文件组织规范                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  文件结构：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ // 文件头注释                                        │   │
│  │ // ==============================================   │   │
│  │ // 文件名：PlayerController.cs                      │   │
│  │ // 命名空间: AFramework.Game                        │   │
│  │ // 依赖: UniTask, R3                                │   │
│  │ // ==============================================   │   │
│  │                                                     │   │
│  │ #region Using 声明                                  │   │
│  │ using System;                                       │   │
│  │ using UnityEngine;                                  │   │
│  │ using AFramework.DI;                                │   │
│  │ #endregion                                          │   │
│  │                                                     │   │
│  │ namespace AFramework.Game                           │   │
│  │ {                                                   │   │
│  │     #region 常量和枚举                              │   │
│  │     #endregion                                      │   │
│  │                                                     │   │
│  │     #region 字段                                    │   │
│  │     #endregion                                      │   │
│  │                                                     │   │
│  │     #region 属性                                    │   │
│  │     #endregion                                      │   │
│  │                                                     │   │
│  │     #region 生命周期方法                            │   │
│  │     #endregion                                      │   │
│  │                                                     │   │
│  │     #region 公共方法                                │   │
│  │     #endregion                                      │   │
│  │                                                     │   │
│  │     #region 私有方法                                │   │
│  │     #endregion                                      │   │
│  │ }                                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 9.3 性能最佳实践

| 场景 | 推荐做法 | 避免做法 |
|------|----------|----------|
| 对象创建 | 使用Pool模块 | 频繁 new/Instantiate |
| 字符串拼接 | StringBuilder 或插值 | 循环中使用 + 拼接 |
| 集合遍历 | for/foreach + Span | LINQ（热路径） |
| 异步操作 | UniTask (Extension模块) | Task（GC分配） |
| 事件订阅 | 及时取消订阅 | 忘记取消导致泄漏 |
| 组件获取 | 缓存引用 | 每帧 GetComponent |
| 物理查询 | NonAlloc 版本 | 分配数组版本 |
| 日志输出 | 条件编译包裹 | Release 版本输出日志 |

### 9.4 调试与诊断 (DebugLog模块)

#### 9.4.1 日志级别使用

| 级别 | 用途 | 示例 |
|------|------|------|
| Trace | 详细追踪信息 | 方法进入/退出 |
| Debug | 调试信息 | 变量值、状态变化 |
| Info | 一般信息 | 模块初始化完成 |
| Warning | 警告信息 | 配置缺失使用默认值 |
| Error | 错误信息 | 资源加载失败 |
| Fatal | 致命错误 | 框架初始化失败 |

#### 9.4.2 性能分析工具使用

```
┌─────────────────────────────────────────────────────────────┐
│                     性能分析工具链                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  开发阶段：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ - Unity Profiler：CPU/GPU/内存分析                  │   │
│  │ - Memory Profiler：堆内存详细分析                   │   │
│  │ - Frame Debugger：渲染调试                          │   │
│  │ - DebugLog模块：框架内置调试器                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  测试阶段：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ - Profile Analyzer：多帧数据分析                    │   │
│  │ - 自动化性能测试：CI/CD 集成                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  发布阶段：                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ - 远程性能监控                                      │   │
│  │ - 崩溃报告收集                                      │   │
│  │ - 用户行为分析                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 9.5 版本迁移指南

#### 9.5.1 框架升级步骤

```
┌─────────────────────────────────────────────────────────────┐
│                     框架升级步骤                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  步骤1：备份项目                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ - 完整备份项目文件                                   │   │
│  │ - 记录当前框架版本                                   │   │
│  │ - 导出项目设置                                       │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  步骤2：查阅更新日志                                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ - 阅读 CHANGELOG.md                                 │   │
│  │ - 识别破坏性变更                                     │   │
│  │ - 规划迁移策略                                       │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  步骤3：更新框架                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ - 更新 Package Manager 中的框架包                   │   │
│  │ - 更新相关依赖包                                     │   │
│  │ - 重新生成代码                                       │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  步骤4：修复编译错误                                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ - 按照迁移指南修改代码                               │   │
│  │ - 更新已废弃的 API 调用                             │   │
│  │ - 调整配置文件格式                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  步骤5：测试验证                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ - 运行单元测试                                       │   │
│  │ - 执行集成测试                                       │   │
│  │ - 进行性能对比测试                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 附录

### A. 术语表

| 术语 | 定义 |
|------|------|
| AFramework | Aggregation Framework 的缩写，本框架名称 |
| Pool | 对象池模块 (AFramework.Pool) |
| Localization | 本地化模块 (AFramework.Localization) |
| ECS | 实体组件系统模块 (AFramework.ECS) |
| Config | 配置模块 (AFramework.Config) |
| DebugLog | 调试器模块 (AFramework.DebugLog) |
| CSharpExtension | C#扩展库 (AFramework.CSharpExtension) |
| UnityExtension | Unity扩展库 (AFramework.UnityExtension) |
| Algorithm | 算法优化库 (AFramework.Algorithm) |
| Serialization | 序列化模块 (AFramework.Serialization) |
| DI | 依赖注入模块 (AFramework.DI) |
| BurstExtension | Burst编译扩展 (AFramework.Burst) |
| Extension | 插件扩展模块 (AFramework.Extension) |
| AFrameworkDB | 内存数据库模块 (AFramework.DB) |
| EventSystem | 事件消息系统 (AFramework.EventSystem) |
| TaskSystem | 任务系统 (AFramework.TaskSystem) |
| ResourceSystem | 资源管理系统 (AFramework.ResourceSystem) |
| CQRS | Command Query Responsibility Segregation，命令查询职责分离 |
| SIMD | Single Instruction Multiple Data，单指令多数据 |
| GC | Garbage Collection，垃圾回收 |
| AOT | Ahead-Of-Time，预编译 |

### B. 参考资源

| 资源 | 链接 |
|------|------|
| Unity 2022.3 脚本 API | https://docs.unity3d.com/2022.3/Documentation/ScriptReference/ |
| Unity Entities 1.43 | https://docs.unity3d.com/Packages/com.unity.entities@1.0/manual/ |
| Unity Burst 1.8.27 | https://docs.unity3d.com/Packages/com.unity.burst@1.8/manual/ |
| Unity Addressables 1.28 | https://docs.unity3d.com/Packages/com.unity.addressables@1.28/manual/ |
| UniTask | https://github.com/Cysharp/UniTask |
| R3 | https://github.com/Cysharp/R3 |
| VContainer | https://github.com/hadashiA/VContainer |
| MessagePipe | https://github.com/Cysharp/MessagePipe |
| MemoryPack | https://github.com/Cysharp/MemoryPack |
| MasterMemory | https://github.com/Cysharp/MasterMemory |

### C. 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0.0 | 2025-12-31 | 初始版本，完成框架设计文档 |