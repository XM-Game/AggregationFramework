# AFramework.Serialization 序列化系统技术设计文档

## 文档信息

| 项目 | 内容 |
|------|------|
| 模块名称 | AFramework.Serialization |
| 版本 | 1.0.0 |
| 适用 Unity 版本 | 2022.3 LTS ~ Unity 6.x |
| 命名空间 | AFramework.Serialization |
| 依赖模块 | AFramework.CSharpExtension, AFramework.BurstExtension |

---

## 第一章：概述

### 1.1 模块定位

AFramework.Serialization 是 AFramework 框架的核心序列化模块，专为 Unity 游戏开发和高性能应用场景设计。该模块提供企业级的序列化解决方案，融合了 MemoryPack 的极致性能理念与 Unity 生态的深度集成，旨在成为 Unity 项目中最高效、最灵活的序列化框架。

### 1.2 设计愿景

构建一个"零妥协"的序列化系统：
- 性能上不妥协：追求接近内存拷贝的理论极限
- 功能上不妥协：覆盖游戏开发的全部序列化场景
- 易用性上不妥协：提供简洁直观的 API 设计
- 扩展性上不妥协：支持任意自定义类型和格式

### 1.3 核心价值主张

| 价值维度 | 具体表现 |
|----------|----------|
| 极致性能 | 零拷贝、零分配、SIMD 优化，性能超越 MessagePack 2-3 倍 |
| Unity 原生 | 完整支持 Unity 类型、ECS 类型、Burst 编译 |
| 多格式支持 | Binary（高性能）、YAML（可读性）、JSON（互操作） |
| 版本兼容 | 支持数据结构演进，向后兼容无忧 |
| 开发友好 | 源代码生成器自动生成序列化代码，零配置即可使用 |

### 1.4 与 MemoryPack 的关系

AFramework.Serialization 深度参考 MemoryPack 的设计理念，但进行了以下差异化设计：

| 对比维度 | MemoryPack | AFramework.Serialization |
|----------|------------|--------------------------|
| 定位 | 通用 .NET 序列化 | Unity 游戏开发专用 |
| Unity 集成 | 基础支持 | 深度集成（ECS、Burst、Addressables） |
| 格式支持 | 仅二进制 | Binary + YAML + JSON |
| 编辑器工具 | 无 | 提供可视化调试工具 |
| 本地化 | 英文 | 中英双语支持 |

---

## 第二章：架构设计

### 2.1 整体架构图


```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    AFramework.Serialization 架构总览                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         应用层 (Application Layer)                       │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │   │
│  │  │ 网络通信    │  │ 数据持久化  │  │ 配置管理    │  │ 存档系统    │    │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│                                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         接口层 (Interface Layer)                         │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │   │
│  │  │                    ISerializer<T> 统一接口                       │    │   │
│  │  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐    │    │   │
│  │  │  │Serialize()│  │Deserialize│  │GetSize()  │  │Clone()    │    │    │   │
│  │  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘    │    │   │
│  │  └─────────────────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│                    ┌─────────────────┼─────────────────┐                        │
│                    ▼                 ▼                 ▼                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         实现层 (Implementation Layer)                    │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │   │
│  │  │ BinarySerializer │  │ YamlSerializer  │  │ JsonSerializer  │          │   │
│  │  │   (高性能)       │  │   (可读性)      │  │   (互操作)      │          │   │
│  │  │                 │  │                 │  │                 │          │   │
│  │  │ • 零拷贝        │  │ • 人类可读      │  │ • 标准格式      │          │   │
│  │  │ • 零分配        │  │ • 注释支持      │  │ • Web 兼容      │          │   │
│  │  │ • SIMD 优化     │  │ • 多文档        │  │ • 跨平台        │          │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│                                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                       格式化器层 (Formatter Layer)                       │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │   │
│  │  │                  FormatterProvider 格式化器注册表                 │    │   │
│  │  └─────────────────────────────────────────────────────────────────┘    │   │
│  │                                   │                                      │   │
│  │         ┌─────────────────────────┼─────────────────────────┐           │   │
│  │         ▼                         ▼                         ▼           │   │
│  │  ┌─────────────┐          ┌─────────────┐          ┌─────────────┐      │   │
│  │  │ 基础类型    │          │ Unity 类型  │          │ 自定义类型  │      │   │
│  │  │ Formatters  │          │ Formatters  │          │ Formatters  │      │   │
│  │  │             │          │             │          │             │      │   │
│  │  │ • int/float │          │ • Vector3   │          │ • 用户定义  │      │   │
│  │  │ • string    │          │ • Color     │          │ • 源码生成  │      │   │
│  │  │ • DateTime  │          │ • Entity    │          │ • 手动实现  │      │   │
│  │  │ • 集合类型  │          │ • Native*   │          │             │      │   │
│  │  └─────────────┘          └─────────────┘          └─────────────┘      │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│                                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        缓冲区层 (Buffer Layer)                           │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │   │
│  │  │ SerializeWriter │  │ SerializeReader │  │ BufferPool      │          │   │
│  │  │                 │  │                 │  │                 │          │   │
│  │  │ • 写入操作      │  │ • 读取操作      │  │ • 对象池        │          │   │
│  │  │ • 缓冲区管理    │  │ • 跨段读取      │  │ • 缓冲区复用    │          │   │
│  │  │ • 流式写入      │  │ • 零拷贝读取    │  │ • 内存管理      │          │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│                                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        基础设施层 (Infrastructure Layer)                 │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │   │
│  │  │ 内存操作    │  │ 压缩算法    │  │ 校验算法    │  │ 编码算法    │    │   │
│  │  │ Utilities   │  │ Compression │  │ Checksum    │  │ Encoding    │    │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 分层职责说明

| 层级 | 职责 | 核心组件 |
|------|------|----------|
| 应用层 | 面向业务的序列化场景 | 网络通信、持久化、配置、存档 |
| 接口层 | 定义统一的序列化契约 | ISerializer、IFormatter、IWriter、IReader |
| 实现层 | 提供多种格式的序列化实现 | BinarySerializer、YamlSerializer、JsonSerializer |
| 格式化器层 | 管理类型到序列化逻辑的映射 | FormatterProvider、各类型 Formatter |
| 缓冲区层 | 高效的内存读写管理 | SerializeWriter、SerializeReader、BufferPool |
| 基础设施层 | 底层工具和算法支持 | 内存操作、压缩、校验、编码 |

### 2.3 核心设计原则

#### 2.3.1 策略模式应用

不同的序列化格式作为不同的策略实现，通过统一的 `ISerializer<T>` 接口进行调用，实现格式无关的序列化操作。

#### 2.3.2 工厂模式应用

`FormatterProvider` 使用工厂模式创建和管理格式化器实例，支持延迟创建和缓存机制。

#### 2.3.3 对象池模式应用

`BufferPool` 使用对象池模式管理缓冲区，减少内存分配和 GC 压力。

#### 2.3.4 访问者模式应用

序列化过程可以视为访问者模式，格式化器作为访问者访问对象结构，实现类型与序列化逻辑的解耦。

---

## 第三章：核心接口设计

### 3.1 ISerializer 接口族

#### 3.1.1 ISerializer<T> 泛型接口

统一的序列化器接口，定义序列化和反序列化的核心契约。

| 方法签名 | 功能描述 |
|----------|----------|
| `byte[] Serialize(T value)` | 将对象序列化为字节数组 |
| `void Serialize(IBufferWriter<byte> writer, T value)` | 将对象序列化到缓冲区写入器 |
| `T Deserialize(ReadOnlySpan<byte> data)` | 从字节数据反序列化对象 |
| `T Deserialize(ReadOnlySequence<byte> data)` | 从字节序列反序列化对象 |
| `int GetSerializedSize(T value)` | 计算序列化后的数据大小 |
| `T Clone(T value)` | 通过序列化实现深拷贝 |

#### 3.1.2 ISerializer 非泛型接口

支持运行时类型的序列化操作。

| 方法签名 | 功能描述 |
|----------|----------|
| `byte[] Serialize(Type type, object value)` | 按指定类型序列化对象 |
| `object Deserialize(Type type, ReadOnlySpan<byte> data)` | 按指定类型反序列化对象 |

#### 3.1.3 IAsyncSerializer<T> 异步接口

支持流式异步序列化操作。

| 方法签名 | 功能描述 |
|----------|----------|
| `ValueTask SerializeAsync(Stream stream, T value, CancellationToken ct)` | 异步序列化到流 |
| `ValueTask<T> DeserializeAsync(Stream stream, CancellationToken ct)` | 异步从流反序列化 |

### 3.2 IFormatter 接口族

#### 3.2.1 IFormatter<T> 泛型接口

类型格式化器接口，定义特定类型的序列化逻辑。

| 方法签名 | 功能描述 |
|----------|----------|
| `void Serialize(ref SerializeWriter writer, ref T value)` | 序列化指定类型的值 |
| `void Deserialize(ref SerializeReader reader, ref T value)` | 反序列化指定类型的值 |

#### 3.2.2 IFormatterResolver 接口

格式化器解析器接口，负责查找和创建格式化器。

| 方法签名 | 功能描述 |
|----------|----------|
| `IFormatter<T> GetFormatter<T>()` | 获取指定类型的格式化器 |
| `IFormatter GetFormatter(Type type)` | 获取指定类型的格式化器（非泛型） |
| `void Register<T>(IFormatter<T> formatter)` | 注册自定义格式化器 |

### 3.3 IWriter/IReader 接口族

#### 3.3.1 ISerializeWriter 接口

序列化写入器接口，定义数据写入操作。

| 方法签名 | 功能描述 |
|----------|----------|
| `void WriteUnmanaged<T>(T value)` | 写入非托管类型值 |
| `void WriteUnmanagedArray<T>(ReadOnlySpan<T> values)` | 写入非托管类型数组 |
| `void WriteString(string value)` | 写入字符串 |
| `void WriteBytes(ReadOnlySpan<byte> bytes)` | 写入字节数组 |
| `void WriteObjectHeader(int memberCount)` | 写入对象头信息 |
| `void WriteCollectionHeader(int count)` | 写入集合头信息 |
| `void WriteNullObjectHeader()` | 写入空对象标记 |
| `void Flush()` | 刷新缓冲区 |

#### 3.3.2 ISerializeReader 接口

序列化读取器接口，定义数据读取操作。

| 方法签名 | 功能描述 |
|----------|----------|
| `T ReadUnmanaged<T>()` | 读取非托管类型值 |
| `void ReadUnmanagedArray<T>(Span<T> destination)` | 读取非托管类型数组 |
| `string ReadString()` | 读取字符串 |
| `ReadOnlySpan<byte> ReadBytes(int length)` | 读取字节数组 |
| `bool TryReadObjectHeader(out int memberCount)` | 尝试读取对象头信息 |
| `int ReadCollectionHeader()` | 读取集合头信息 |
| `bool TryReadNullObjectHeader()` | 尝试读取空对象标记 |

---

## 第四章：序列化器实现

### 4.1 BinarySerializer（二进制序列化器）

#### 4.1.1 定位与特点

BinarySerializer 是 AFramework.Serialization 的核心序列化器，专为高性能场景设计。

| 特性 | 描述 |
|------|------|
| 零拷贝 | 非托管类型直接内存映射，无中间转换 |
| 零分配 | 热路径无 GC 分配，使用对象池和栈分配 |
| SIMD 优化 | 批量数据处理使用 SIMD 指令加速 |
| 紧凑格式 | 最小化序列化数据大小 |
| 快速解析 | 极快的反序列化速度 |

#### 4.1.2 二进制格式规范

##### 数据头格式

| 字段 | 大小 | 描述 |
|------|------|------|
| Magic Number | 4 bytes | 格式标识符 `0x41465253` ("AFRS") |
| Version | 2 bytes | 格式版本号 |
| Flags | 2 bytes | 特性标志位 |
| Checksum | 4 bytes | 数据校验和（可选） |

##### 类型编码格式

| 类型类别 | 编码方式 | 说明 |
|----------|----------|------|
| 非托管类型 | 直接内存拷贝 | int、float、struct 等 |
| 字符串 | 长度前缀 + UTF-8 | VarInt 长度 + 字节数据 |
| 集合 | 长度前缀 + 元素 | VarInt 长度 + 元素序列 |
| 对象 | 成员数 + 成员 | VarInt 成员数 + 成员序列 |
| 空值 | 特殊标记 | 单字节 0xFF |

##### VarInt 编码规则

| 值范围 | 编码长度 | 编码方式 |
|--------|----------|----------|
| 0 ~ 127 | 1 byte | 直接存储 |
| 128 ~ 16383 | 2 bytes | 高位标记 + 数据 |
| 16384 ~ 2097151 | 3 bytes | 高位标记 + 数据 |
| 更大值 | 4-5 bytes | 高位标记 + 数据 |

#### 4.1.3 适用场景

- 高性能网络通信（游戏同步、RPC）
- 实时数据持久化（存档、缓存）
- 消息队列序列化
- 内存数据库存储

### 4.2 YamlSerializer（YAML 序列化器）

#### 4.2.1 定位与特点

YamlSerializer 提供人类可读的序列化格式，适用于配置文件和数据编辑场景。

| 特性 | 描述 |
|------|------|
| 人类可读 | YAML 格式易于阅读和手动编辑 |
| 注释支持 | 支持 YAML 注释，便于文档化 |
| 多文档 | 支持单文件多文档 |
| 类型保持 | 保持数据类型信息 |
| 锚点引用 | 支持 YAML 锚点和引用 |

#### 4.2.2 YAML 格式规范

##### 类型映射规则

| C# 类型 | YAML 表示 |
|---------|-----------|
| int, float, double | 数字字面量 |
| bool | true/false |
| string | 字符串（自动引号） |
| DateTime | ISO 8601 格式 |
| Enum | 枚举名称字符串 |
| Array, List | YAML 序列 |
| Dictionary | YAML 映射 |
| 自定义类 | YAML 映射（属性名: 值） |

##### 特殊类型处理

| Unity 类型 | YAML 表示 |
|------------|-----------|
| Vector3 | `{x: 1.0, y: 2.0, z: 3.0}` |
| Color | `{r: 1.0, g: 0.5, b: 0.0, a: 1.0}` |
| Quaternion | `{x: 0, y: 0, z: 0, w: 1}` |

#### 4.2.3 适用场景

- 游戏配置文件
- 关卡数据定义
- 资源元数据
- 开发工具数据
- 本地化文本

### 4.3 JsonSerializer（JSON 序列化器）

#### 4.3.1 定位与特点

JsonSerializer 提供标准 JSON 格式支持，适用于 Web 互操作和跨平台数据交换。

| 特性 | 描述 |
|------|------|
| 标准格式 | 完全兼容 JSON 标准 (RFC 8259) |
| 互操作性 | 与 Web 服务、第三方系统良好互操作 |
| 性能优化 | 高性能 JSON 解析和生成 |
| 格式化输出 | 支持美化输出和压缩输出 |

#### 4.3.2 适用场景

- RESTful API 通信
- Web 服务数据交换
- 第三方系统集成
- 调试和日志输出

---

## 第五章：格式化器系统

### 5.1 格式化器架构


```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         格式化器系统架构                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                    FormatterProvider (格式化器提供者)                    │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │   │
│  │  │                    格式化器缓存 (Type → Formatter)                │    │   │
│  │  └─────────────────────────────────────────────────────────────────┘    │   │
│  │                                   │                                      │   │
│  │  ┌────────────────────────────────┼────────────────────────────────┐    │   │
│  │  │                                │                                │    │   │
│  │  ▼                                ▼                                ▼    │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │   │
│  │  │ 内置格式化器 │  │ 生成格式化器 │  │ 自定义格式化器│               │   │
│  │  │ (Built-in)   │  │ (Generated)  │  │ (Custom)     │               │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘               │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         内置格式化器分类                                  │   │
│  │                                                                         │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │   │
│  │  │   基础类型       │  │   集合类型       │  │   特殊类型       │         │   │
│  │  │                 │  │                 │  │                 │         │   │
│  │  │ • Int32         │  │ • Array<T>      │  │ • DateTime      │         │   │
│  │  │ • Int64         │  │ • List<T>       │  │ • TimeSpan      │         │   │
│  │  │ • Float         │  │ • Dictionary    │  │ • Guid          │         │   │
│  │  │ • Double        │  │ • HashSet<T>    │  │ • Uri           │         │   │
│  │  │ • Boolean       │  │ • Queue<T>      │  │ • BigInteger    │         │   │
│  │  │ • String        │  │ • Stack<T>      │  │ • Nullable<T>   │         │   │
│  │  │ • Char          │  │ • Tuple         │  │ • Enum          │         │   │
│  │  │ • Decimal       │  │ • ValueTuple    │  │ • Type          │         │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘         │   │
│  │                                                                         │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │   │
│  │  │   Unity 类型    │  │   ECS 类型       │  │   压缩格式化器   │         │   │
│  │  │                 │  │                 │  │                 │         │   │
│  │  │ • Vector2/3/4   │  │ • Entity        │  │ • Brotli        │         │   │
│  │  │ • Quaternion    │  │ • NativeArray   │  │ • LZ4           │         │   │
│  │  │ • Color/Color32 │  │ • NativeList    │  │ • Zstd          │         │   │
│  │  │ • Rect/Bounds   │  │ • NativeHashMap │  │ • BitPack       │         │   │
│  │  │ • Matrix4x4     │  │ • BlobAsset     │  │ • VarInt        │         │   │
│  │  │ • AnimationCurve│  │ • DynamicBuffer │  │ • InternString  │         │   │
│  │  │ • Gradient      │  │                 │  │                 │         │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 内置格式化器清单

#### 5.2.1 基础类型格式化器

| 类型 | 格式化器 | 序列化方式 | 性能特点 |
|------|----------|------------|----------|
| bool | BooleanFormatter | 1 字节 | 零拷贝 |
| byte | ByteFormatter | 1 字节 | 零拷贝 |
| sbyte | SByteFormatter | 1 字节 | 零拷贝 |
| short | Int16Formatter | 2 字节 | 零拷贝 |
| ushort | UInt16Formatter | 2 字节 | 零拷贝 |
| int | Int32Formatter | 4 字节 / VarInt | 零拷贝 |
| uint | UInt32Formatter | 4 字节 / VarInt | 零拷贝 |
| long | Int64Formatter | 8 字节 / VarInt | 零拷贝 |
| ulong | UInt64Formatter | 8 字节 / VarInt | 零拷贝 |
| float | SingleFormatter | 4 字节 | 零拷贝 |
| double | DoubleFormatter | 8 字节 | 零拷贝 |
| decimal | DecimalFormatter | 16 字节 | 零拷贝 |
| char | CharFormatter | 2 字节 | 零拷贝 |

#### 5.2.2 字符串格式化器

| 格式化器 | 编码方式 | 适用场景 |
|----------|----------|----------|
| Utf8StringFormatter | UTF-8 | 网络传输、存储（默认） |
| Utf16StringFormatter | UTF-16 | 本地处理、Unicode 密集 |
| InternStringFormatter | UTF-8 + 内化 | 重复字符串多的场景 |
| CompressedStringFormatter | UTF-8 + 压缩 | 长字符串场景 |

#### 5.2.3 集合类型格式化器

| 类型 | 格式化器 | 优化特点 |
|------|----------|----------|
| T[] | ArrayFormatter<T> | 非托管类型块拷贝 |
| List<T> | ListFormatter<T> | 预分配容量 |
| Dictionary<K,V> | DictionaryFormatter<K,V> | 哈希优化 |
| HashSet<T> | HashSetFormatter<T> | 哈希优化 |
| Queue<T> | QueueFormatter<T> | 顺序优化 |
| Stack<T> | StackFormatter<T> | 顺序优化 |
| LinkedList<T> | LinkedListFormatter<T> | 节点优化 |
| ReadOnlyCollection<T> | ReadOnlyCollectionFormatter<T> | 只读优化 |

#### 5.2.4 Unity 类型格式化器

| 类型 | 格式化器 | 序列化大小 |
|------|----------|------------|
| Vector2 | Vector2Formatter | 8 字节 |
| Vector3 | Vector3Formatter | 12 字节 |
| Vector4 | Vector4Formatter | 16 字节 |
| Vector2Int | Vector2IntFormatter | 8 字节 |
| Vector3Int | Vector3IntFormatter | 12 字节 |
| Quaternion | QuaternionFormatter | 16 字节 |
| Color | ColorFormatter | 16 字节 |
| Color32 | Color32Formatter | 4 字节 |
| Rect | RectFormatter | 16 字节 |
| RectInt | RectIntFormatter | 16 字节 |
| Bounds | BoundsFormatter | 24 字节 |
| BoundsInt | BoundsIntFormatter | 24 字节 |
| Matrix4x4 | Matrix4x4Formatter | 64 字节 |
| AnimationCurve | AnimationCurveFormatter | 可变 |
| Gradient | GradientFormatter | 可变 |
| LayerMask | LayerMaskFormatter | 4 字节 |
| RectOffset | RectOffsetFormatter | 16 字节 |

#### 5.2.5 ECS 类型格式化器

| 类型 | 格式化器 | 特殊处理 |
|------|----------|----------|
| Entity | EntityFormatter | Index + Version |
| NativeArray<T> | NativeArrayFormatter<T> | 直接内存访问 |
| NativeList<T> | NativeListFormatter<T> | 容量优化 |
| NativeHashMap<K,V> | NativeHashMapFormatter<K,V> | 哈希优化 |
| NativeHashSet<T> | NativeHashSetFormatter<T> | 哈希优化 |
| BlobAssetReference<T> | BlobAssetFormatter<T> | Blob 数据处理 |
| DynamicBuffer<T> | DynamicBufferFormatter<T> | 缓冲区优化 |
| FixedString32/64/128 | FixedStringFormatter | 固定大小 |

#### 5.2.6 特殊格式化器

| 格式化器 | 功能描述 | 适用场景 |
|----------|----------|----------|
| NullableFormatter<T> | 可空类型处理 | Nullable<T> |
| EnumFormatter<T> | 枚举类型处理 | 所有枚举 |
| TupleFormatter | 元组类型处理 | Tuple、ValueTuple |
| KeyValuePairFormatter | 键值对处理 | KeyValuePair<K,V> |
| DateTimeFormatter | 日期时间处理 | DateTime、DateTimeOffset |
| TimeSpanFormatter | 时间间隔处理 | TimeSpan |
| GuidFormatter | GUID 处理 | Guid |
| UriFormatter | URI 处理 | Uri |
| BigIntegerFormatter | 大整数处理 | BigInteger |
| TypeFormatter | 类型信息处理 | Type |

### 5.3 压缩格式化器

#### 5.3.1 压缩算法对比

| 算法 | 压缩率 | 压缩速度 | 解压速度 | 适用场景 |
|------|--------|----------|----------|----------|
| Brotli | 高 | 中 | 快 | 存储、网络传输 |
| LZ4 | 中 | 极快 | 极快 | 实时场景 |
| Zstd | 高 | 快 | 快 | 平衡场景 |
| Gzip | 中 | 中 | 中 | 兼容性场景 |

#### 5.3.2 压缩级别配置

| 级别 | 描述 | 压缩率 | 速度 |
|------|------|--------|------|
| Fastest | 最快速度 | 低 | 极快 |
| Fast | 快速 | 中低 | 快 |
| Optimal | 平衡 | 中 | 中 |
| SmallestSize | 最小体积 | 高 | 慢 |

### 5.4 自定义格式化器

#### 5.4.1 实现方式

| 方式 | 描述 | 适用场景 |
|------|------|----------|
| 继承 FormatterBase<T> | 继承抽象基类实现 | 标准自定义类型 |
| 实现 IFormatter<T> | 直接实现接口 | 完全控制序列化逻辑 |
| 源代码生成 | 自动生成格式化器 | 标记 [Serializable] 的类型 |
| 属性标记 | 使用属性指定格式化器 | 字段级别自定义 |

#### 5.4.2 格式化器注册优先级

| 优先级 | 来源 | 描述 |
|--------|------|------|
| 1 (最高) | 手动注册 | 通过 Register<T>() 注册 |
| 2 | 属性标记 | [CustomFormatter] 属性 |
| 3 | 源代码生成 | 自动生成的格式化器 |
| 4 (最低) | 内置格式化器 | 系统内置格式化器 |

---

## 第六章：序列化模式

### 6.1 模式概览

| 模式 | 描述 | 性能 | 功能 |
|------|------|------|------|
| Object | 标准对象序列化 | ★★★★★ | 基础 |
| VersionTolerant | 版本容错序列化 | ★★★★☆ | 版本兼容 |
| CircularReference | 循环引用序列化 | ★★★☆☆ | 循环引用 |
| Polymorphic | 多态序列化 | ★★★★☆ | 多态支持 |
| Streaming | 流式序列化 | ★★★★☆ | 大数据 |

### 6.2 Object 模式（默认）

#### 6.2.1 特点

- 按字段声明顺序序列化
- 性能最优，零开销
- 不支持版本容错
- 适用于高性能场景

#### 6.2.2 布局规则

| 规则 | 描述 |
|------|------|
| 顺序布局 | 按字段声明顺序序列化 |
| 紧凑格式 | 无字段名，无类型信息 |
| 固定结构 | 字段顺序变化会导致反序列化失败 |

### 6.3 VersionTolerant 模式

#### 6.3.1 特点

- 支持字段顺序变化
- 支持字段增减
- 支持类型兼容转换
- 适用于长期维护的数据结构

#### 6.3.2 版本兼容规则

| 变更类型 | 兼容性 | 处理方式 |
|----------|--------|----------|
| 新增字段 | ✅ 兼容 | 使用默认值 |
| 删除字段 | ✅ 兼容 | 忽略数据 |
| 字段重排 | ✅ 兼容 | 按名称/ID 匹配 |
| 类型变更 | ⚠️ 部分兼容 | 兼容类型自动转换 |
| 字段重命名 | ❌ 不兼容 | 需要迁移处理 |

#### 6.3.3 类型兼容转换表

| 源类型 | 目标类型 | 转换方式 |
|--------|----------|----------|
| int | long | 扩展转换 |
| float | double | 扩展转换 |
| int | float | 数值转换 |
| string | int | 解析转换 |
| Enum | int | 底层值转换 |

### 6.4 CircularReference 模式

#### 6.4.1 特点

- 支持循环引用的对象图
- 自动检测和处理循环引用
- 使用引用表跟踪已序列化对象
- 性能略有下降

#### 6.4.2 引用跟踪机制

| 机制 | 描述 |
|------|------|
| 对象 ID 分配 | 首次序列化时分配唯一 ID |
| 引用标记 | 后续引用使用 ID 标记 |
| 引用恢复 | 反序列化时恢复对象引用 |
| 深度限制 | 防止无限递归 |

### 6.5 Polymorphic 模式

#### 6.5.1 特点

- 支持接口和抽象类的多态序列化
- 保存类型信息
- 自动恢复正确的派生类型
- 需要预先注册类型映射

#### 6.5.2 联合类型定义

| 元素 | 描述 |
|------|------|
| 基类型 | 接口或抽象类 |
| 派生类型 | 具体实现类 |
| 类型 ID | 派生类型的唯一标识 |
| 类型映射 | ID 到类型的映射表 |

### 6.6 Streaming 模式

#### 6.6.1 特点

- 支持大数据流式处理
- 分块序列化和反序列化
- 内存友好，避免一次性加载
- 适用于大型文件和网络流

#### 6.6.2 流式处理机制

| 机制 | 描述 |
|------|------|
| 分块写入 | 数据分块写入流 |
| 分块读取 | 数据分块读取处理 |
| 缓冲区管理 | 智能缓冲区分配和复用 |
| 进度回调 | 支持进度通知 |

---

## 第七章：属性系统

### 7.1 类型级别属性

#### 7.1.1 [Serializable] 属性

标记类型为可序列化，触发源代码生成器生成序列化代码。

| 参数 | 类型 | 描述 |
|------|------|------|
| GenerateMode | GenerateMode | 生成模式（Object/VersionTolerant/...） |
| Layout | SerializeLayout | 布局方式（Sequential/Explicit） |
| IncludePrivate | bool | 是否包含私有成员 |

#### 7.1.2 [UnionType] 属性

定义联合类型，支持多态序列化。

| 参数 | 类型 | 描述 |
|------|------|------|
| TypeId | int | 派生类型的唯一标识 |
| DerivedType | Type | 派生类型 |

#### 7.1.3 [SerializeVersion] 属性

标记类型的版本号，用于版本迁移。

| 参数 | 类型 | 描述 |
|------|------|------|
| Version | int | 版本号 |
| MinCompatibleVersion | int | 最小兼容版本 |

### 7.2 成员级别属性

#### 7.2.1 [SerializeIgnore] 属性

忽略字段或属性，不参与序列化。

#### 7.2.2 [SerializeInclude] 属性

显式包含字段或属性（用于 VersionTolerant 模式）。

| 参数 | 类型 | 描述 |
|------|------|------|
| Order | int | 序列化顺序（可选） |
| Name | string | 字段名称（可选） |

#### 7.2.3 [SerializeOrder] 属性

指定序列化顺序。

| 参数 | 类型 | 描述 |
|------|------|------|
| Order | int | 序列化顺序 |

#### 7.2.4 [SerializeRequired] 属性

标记字段为必需字段，反序列化时缺失会抛出异常。

#### 7.2.5 [SerializeDefault] 属性

指定字段的默认值。

| 参数 | 类型 | 描述 |
|------|------|------|
| Value | object | 默认值 |

#### 7.2.6 [SerializeConstructor] 属性

标记用于反序列化的构造函数。

### 7.3 生命周期属性

#### 7.3.1 [OnSerializing] 属性

序列化前调用的方法，用于数据预处理。

#### 7.3.2 [OnSerialized] 属性

序列化后调用的方法，用于数据后处理。

#### 7.3.3 [OnDeserializing] 属性

反序列化前调用的方法，用于初始化。

#### 7.3.4 [OnDeserialized] 属性

反序列化后调用的方法，用于数据验证。

### 7.4 格式化器属性

#### 7.4.1 [CustomFormatter] 属性

指定自定义格式化器。

| 参数 | 类型 | 描述 |
|------|------|------|
| FormatterType | Type | 格式化器类型 |

#### 7.4.2 [Utf8String] 属性

使用 UTF-8 编码序列化字符串。

#### 7.4.3 [Utf16String] 属性

使用 UTF-16 编码序列化字符串。

#### 7.4.4 [InternString] 属性

启用字符串内化。

#### 7.4.5 [Compress] 属性

启用压缩。

| 参数 | 类型 | 描述 |
|------|------|------|
| Algorithm | CompressionAlgorithm | 压缩算法 |
| Level | CompressionLevel | 压缩级别 |

#### 7.4.6 [BitPack] 属性

启用位打包（用于布尔数组）。

---

## 第八章：缓冲区管理

### 8.1 缓冲区架构


```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           缓冲区管理架构                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         BufferPool (缓冲区池)                            │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │   │
│  │  │                    ArrayPool<byte> 底层池                        │    │   │
│  │  └─────────────────────────────────────────────────────────────────┘    │   │
│  │                                   │                                      │   │
│  │         ┌─────────────────────────┼─────────────────────────┐           │   │
│  │         ▼                         ▼                         ▼           │   │
│  │  ┌──────────────┐          ┌──────────────┐          ┌──────────────┐   │   │
│  │  │ 小缓冲区池   │          │ 中缓冲区池   │          │ 大缓冲区池   │   │   │
│  │  │ (≤4KB)       │          │ (4KB~64KB)   │          │ (>64KB)      │   │   │
│  │  └──────────────┘          └──────────────┘          └──────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│                    ┌─────────────────┼─────────────────┐                        │
│                    ▼                                   ▼                        │
│  ┌─────────────────────────────────┐  ┌─────────────────────────────────┐      │
│  │      SerializeWriter            │  │      SerializeReader            │      │
│  │                                 │  │                                 │      │
│  │  • 缓冲区写入                   │  │  • 缓冲区读取                   │      │
│  │  • 自动扩容                     │  │  • 跨段读取                     │      │
│  │  • 流式写入                     │  │  • 零拷贝读取                   │      │
│  │  • 位置追踪                     │  │  • 位置追踪                     │      │
│  └─────────────────────────────────┘  └─────────────────────────────────┘      │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 SerializeWriter（序列化写入器）

#### 8.2.1 核心功能

| 功能 | 描述 |
|------|------|
| 缓冲区管理 | 自动管理缓冲区分配和扩容 |
| 类型写入 | 提供各种类型的写入方法 |
| 流式写入 | 支持 IBufferWriter<byte> 接口 |
| 位置追踪 | 追踪当前写入位置 |

#### 8.2.2 写入方法

| 方法 | 描述 | 性能特点 |
|------|------|----------|
| WriteUnmanaged<T> | 写入非托管类型 | 零拷贝 |
| WriteUnmanagedSpan<T> | 写入非托管类型数组 | 块拷贝 |
| WriteString | 写入字符串 | UTF-8 编码 |
| WriteBytes | 写入字节数组 | 直接拷贝 |
| WriteVarInt | 写入变长整数 | 紧凑编码 |
| WriteObjectHeader | 写入对象头 | 成员计数 |
| WriteCollectionHeader | 写入集合头 | 元素计数 |

### 8.3 SerializeReader（序列化读取器）

#### 8.3.1 核心功能

| 功能 | 描述 |
|------|------|
| 缓冲区读取 | 从缓冲区读取数据 |
| 跨段读取 | 支持 ReadOnlySequence<byte> |
| 零拷贝读取 | 直接返回内存引用 |
| 位置追踪 | 追踪当前读取位置 |

#### 8.3.2 读取方法

| 方法 | 描述 | 性能特点 |
|------|------|----------|
| ReadUnmanaged<T> | 读取非托管类型 | 零拷贝 |
| ReadUnmanagedSpan<T> | 读取非托管类型数组 | 块拷贝 |
| ReadString | 读取字符串 | UTF-8 解码 |
| ReadBytes | 读取字节数组 | 直接拷贝 |
| ReadVarInt | 读取变长整数 | 紧凑解码 |
| TryReadObjectHeader | 尝试读取对象头 | 成员计数 |
| ReadCollectionHeader | 读取集合头 | 元素计数 |

### 8.4 BufferPool（缓冲区池）

#### 8.4.1 池化策略

| 策略 | 描述 |
|------|------|
| 分级池化 | 按大小分级管理缓冲区 |
| 线程本地 | 每个线程独立的缓冲区池 |
| 延迟回收 | 延迟回收减少分配频率 |
| 容量限制 | 限制池大小防止内存泄漏 |

#### 8.4.2 缓冲区大小分级

| 级别 | 大小范围 | 典型用途 |
|------|----------|----------|
| Tiny | ≤256B | 小对象序列化 |
| Small | 256B~4KB | 普通对象序列化 |
| Medium | 4KB~64KB | 集合序列化 |
| Large | 64KB~1MB | 大数据序列化 |
| Huge | >1MB | 超大数据序列化 |

---

## 第九章：性能优化

### 9.1 编译时优化

#### 9.1.1 源代码生成器

| 优化点 | 描述 |
|--------|------|
| 零反射 | 编译时生成序列化代码，无运行时反射 |
| 类型特化 | 为每个类型生成特化代码 |
| 内联优化 | 生成的代码可完全内联 |
| 常量折叠 | 编译时计算常量值 |

#### 9.1.2 Burst 编译支持

| 优化点 | 描述 |
|--------|------|
| SIMD 向量化 | 自动向量化批量操作 |
| 循环优化 | 循环展开和优化 |
| 内存访问优化 | 优化内存访问模式 |
| 分支消除 | 消除不必要的分支 |

### 9.2 运行时优化

#### 9.2.1 内存优化

| 优化技术 | 描述 | 效果 |
|----------|------|------|
| 零分配 | 热路径无 GC 分配 | 消除 GC 暂停 |
| 对象池 | 复用缓冲区和写入器 | 减少分配 |
| 栈分配 | 小对象使用 stackalloc | 避免堆分配 |
| 缓冲区复用 | 复用序列化缓冲区 | 减少分配 |

#### 9.2.2 CPU 优化

| 优化技术 | 描述 | 效果 |
|----------|------|------|
| 零拷贝 | 非托管类型直接内存映射 | 最小化拷贝 |
| SIMD | 批量数据使用 SIMD 指令 | 并行处理 |
| 缓存友好 | 优化内存访问模式 | 提高缓存命中 |
| 分支预测 | 优化分支结构 | 减少分支失败 |

#### 9.2.3 算法优化

| 优化技术 | 描述 | 效果 |
|----------|------|------|
| VarInt 编码 | 小整数使用变长编码 | 减少数据大小 |
| 批量处理 | 批量处理集合元素 | 减少调用开销 |
| 延迟计算 | 延迟计算非必需数据 | 减少计算量 |
| 结果缓存 | 缓存计算结果 | 避免重复计算 |

### 9.3 性能基准

#### 9.3.1 与其他框架对比

| 框架 | 序列化速度 | 反序列化速度 | 数据大小 |
|------|------------|--------------|----------|
| AFramework.Serialization | 1.0x (基准) | 1.0x (基准) | 1.0x (基准) |
| MemoryPack | 1.0x | 1.0x | 1.0x |
| MessagePack | 0.4x | 0.5x | 1.1x |
| System.Text.Json | 0.2x | 0.3x | 1.5x |
| Protobuf | 0.3x | 0.4x | 0.9x |
| BinaryFormatter | 0.05x | 0.1x | 2.0x |

#### 9.3.2 典型场景性能

| 场景 | 数据大小 | 序列化时间 | 反序列化时间 |
|------|----------|------------|--------------|
| 简单对象 (10 字段) | 100B | <1μs | <1μs |
| 复杂对象 (100 字段) | 1KB | ~5μs | ~5μs |
| 小集合 (100 元素) | 1KB | ~10μs | ~10μs |
| 大集合 (10000 元素) | 100KB | ~500μs | ~500μs |
| 嵌套对象 (深度 10) | 10KB | ~50μs | ~50μs |

---

## 第十章：Unity 集成

### 10.1 Unity 类型支持

#### 10.1.1 数学类型

| 类型 | 序列化方式 | 特殊处理 |
|------|------------|----------|
| Vector2/3/4 | 直接内存拷贝 | 无 |
| Vector2Int/3Int | 直接内存拷贝 | 无 |
| Quaternion | 直接内存拷贝 | 可选归一化 |
| Matrix4x4 | 直接内存拷贝 | 无 |

#### 10.1.2 颜色类型

| 类型 | 序列化方式 | 特殊处理 |
|------|------------|----------|
| Color | 4 个 float | 无 |
| Color32 | 4 个 byte | 紧凑格式 |

#### 10.1.3 几何类型

| 类型 | 序列化方式 | 特殊处理 |
|------|------------|----------|
| Rect/RectInt | 4 个数值 | 无 |
| Bounds/BoundsInt | 6 个数值 | 无 |

#### 10.1.4 曲线类型

| 类型 | 序列化方式 | 特殊处理 |
|------|------------|----------|
| AnimationCurve | 关键帧数组 | 预后切线 |
| Gradient | 颜色/Alpha 键 | 模式信息 |

### 10.2 ECS 集成

#### 10.2.1 Entity 序列化

| 场景 | 处理方式 |
|------|----------|
| 同世界 | Index + Version |
| 跨世界 | 需要实体映射 |
| 持久化 | 需要实体重建 |

#### 10.2.2 NativeContainer 序列化

| 容器 | 序列化方式 | 注意事项 |
|------|------------|----------|
| NativeArray<T> | 直接内存访问 | 需要 Allocator |
| NativeList<T> | 长度 + 数据 | 需要 Allocator |
| NativeHashMap<K,V> | 键值对数组 | 需要 Allocator |

#### 10.2.3 Blob 资产序列化

| 类型 | 序列化方式 | 注意事项 |
|------|------------|----------|
| BlobAssetReference<T> | Blob 数据 | 需要重建引用 |
| BlobArray<T> | 数组数据 | 偏移量处理 |
| BlobString | 字符串数据 | UTF-8 编码 |

### 10.3 Burst 编译支持

#### 10.3.1 Burst 兼容类型

| 类型类别 | Burst 兼容性 |
|----------|--------------|
| 非托管类型 | ✅ 完全兼容 |
| NativeContainer | ✅ 完全兼容 |
| 托管类型 | ❌ 不兼容 |
| 字符串 | ❌ 不兼容 |

#### 10.3.2 Burst Job 序列化

| 场景 | 支持方式 |
|------|----------|
| Job 内序列化 | 使用 Burst 兼容 API |
| Job 外序列化 | 使用标准 API |
| 混合场景 | 分离 Burst/非 Burst 代码 |

### 10.4 IL2CPP 兼容性

#### 10.4.1 AOT 限制处理

| 限制 | 处理方式 |
|------|----------|
| 泛型实例化 | 源代码生成预实例化 |
| 反射限制 | 避免运行时反射 |
| 动态代码 | 使用静态生成代码 |

#### 10.4.2 平台特定优化

| 平台 | 优化策略 |
|------|----------|
| iOS | AOT 友好代码 |
| Android | ARM NEON 优化 |
| WebGL | 内存限制优化 |
| 主机平台 | 平台特定 SIMD |

---

## 第十一章：高级功能

### 11.1 版本迁移

#### 11.1.1 迁移策略

| 策略 | 描述 | 适用场景 |
|------|------|----------|
| 自动迁移 | 自动处理兼容变更 | 字段增减 |
| 手动迁移 | 自定义迁移逻辑 | 复杂变更 |
| 版本分支 | 按版本分支处理 | 大版本变更 |

#### 11.1.2 迁移回调

| 回调 | 触发时机 | 用途 |
|------|----------|------|
| OnMigrating | 迁移开始前 | 准备迁移 |
| OnMigrated | 迁移完成后 | 验证数据 |
| OnVersionMismatch | 版本不匹配时 | 自定义处理 |

### 11.2 数据校验

#### 11.2.1 校验算法

| 算法 | 描述 | 性能 |
|------|------|------|
| CRC32 | 循环冗余校验 | 快 |
| XXHash | 高速哈希 | 极快 |
| SHA256 | 安全哈希 | 慢 |

#### 11.2.2 校验模式

| 模式 | 描述 | 适用场景 |
|------|------|----------|
| None | 无校验 | 高性能场景 |
| Header | 仅校验头部 | 快速验证 |
| Full | 完整校验 | 数据完整性 |

### 11.3 加密支持

#### 11.3.1 加密算法

| 算法 | 描述 | 适用场景 |
|------|------|----------|
| AES-256 | 对称加密 | 数据保护 |
| XOR | 简单混淆 | 轻量保护 |

#### 11.3.2 加密模式

| 模式 | 描述 | 性能影响 |
|------|------|----------|
| None | 无加密 | 无 |
| Obfuscate | 简单混淆 | 极小 |
| Encrypt | 完整加密 | 中等 |

### 11.4 调试支持

#### 11.4.1 调试工具

| 工具 | 功能 |
|------|------|
| SerializeInspector | 可视化序列化数据 |
| SizeAnalyzer | 分析序列化大小 |
| PerformanceProfiler | 性能分析 |

#### 11.4.2 日志级别

| 级别 | 描述 |
|------|------|
| None | 无日志 |
| Error | 仅错误 |
| Warning | 警告和错误 |
| Info | 信息级别 |
| Debug | 调试级别 |
| Verbose | 详细级别 |

---

## 第十二章：使用场景

### 12.1 网络通信

#### 12.1.1 适用场景

- 游戏状态同步
- RPC 调用
- 实时数据传输
- 消息队列

#### 12.1.2 推荐配置

| 配置项 | 推荐值 | 原因 |
|--------|--------|------|
| 序列化器 | BinarySerializer | 最高性能 |
| 模式 | Object | 最小开销 |
| 压缩 | LZ4 (可选) | 快速压缩 |
| 校验 | CRC32 (可选) | 快速校验 |

### 12.2 数据持久化

#### 12.2.1 适用场景

- 游戏存档
- 配置保存
- 缓存数据
- 数据库存储

#### 12.2.2 推荐配置

| 配置项 | 推荐值 | 原因 |
|--------|--------|------|
| 序列化器 | BinarySerializer | 高性能 |
| 模式 | VersionTolerant | 版本兼容 |
| 压缩 | Zstd | 平衡压缩 |
| 校验 | XXHash | 数据完整性 |

### 12.3 配置管理

#### 12.3.1 适用场景

- 游戏配置
- 关卡数据
- 资源定义
- 本地化文本

#### 12.3.2 推荐配置

| 配置项 | 推荐值 | 原因 |
|--------|--------|------|
| 序列化器 | YamlSerializer | 可读性 |
| 模式 | VersionTolerant | 版本兼容 |
| 压缩 | None | 保持可读 |
| 校验 | None | 无需校验 |

### 12.4 ECS 数据序列化

#### 12.4.1 适用场景

- 世界状态保存
- 实体快照
- 组件数据传输
- ECS 调试

#### 12.4.2 推荐配置

| 配置项 | 推荐值 | 原因 |
|--------|--------|------|
| 序列化器 | BinarySerializer | 高性能 |
| 模式 | Object | 最小开销 |
| 压缩 | None | 保持性能 |
| 校验 | None | 保持性能 |

---

## 第十三章：开发路线图

### 13.1 第一阶段：核心框架 (P0)

| 任务 | 描述 | 状态 |
|------|------|------|
| 接口定义 | ISerializer、IFormatter 等核心接口 | 待开发 |
| BinarySerializer | 高性能二进制序列化器 | 待开发 |
| 基础格式化器 | 基础类型格式化器 | 待开发 |
| 缓冲区管理 | SerializeWriter、SerializeReader | 待开发 |
| 格式化器注册表 | FormatterProvider | 待开发 |

### 13.2 第二阶段：性能优化 (P0)

| 任务 | 描述 | 状态 |
|------|------|------|
| 零拷贝实现 | 非托管类型零拷贝 | 待开发 |
| 对象池 | 缓冲区池化 | 待开发 |
| SIMD 优化 | 批量操作 SIMD 加速 | 待开发 |
| 源代码生成器 | 自动生成序列化代码 | 待开发 |

### 13.3 第三阶段：Unity 集成 (P0)

| 任务 | 描述 | 状态 |
|------|------|------|
| Unity 类型支持 | Vector、Color 等类型 | 待开发 |
| ECS 类型支持 | Entity、NativeArray 等 | 待开发 |
| Burst 支持 | Burst 兼容 API | 待开发 |
| IL2CPP 兼容 | AOT 友好实现 | 待开发 |

### 13.4 第四阶段：高级功能 (P1)

| 任务 | 描述 | 状态 |
|------|------|------|
| 版本容错 | VersionTolerant 模式 | 待开发 |
| 循环引用 | CircularReference 模式 | 待开发 |
| 多态序列化 | Polymorphic 模式 | 待开发 |
| 压缩支持 | Brotli、LZ4、Zstd | 待开发 |

### 13.5 第五阶段：多格式支持 (P1)

| 任务 | 描述 | 状态 |
|------|------|------|
| YamlSerializer | YAML 序列化器 | 待开发 |
| JsonSerializer | JSON 序列化器 | 待开发 |
| 格式转换 | 格式间转换工具 | 待开发 |

### 13.6 第六阶段：工具和文档 (P2)

| 任务 | 描述 | 状态 |
|------|------|------|
| 编辑器工具 | 可视化调试工具 | 待开发 |
| 性能分析 | 性能分析工具 | 待开发 |
| API 文档 | 完整 API 文档 | 待开发 |
| 使用示例 | 示例项目 | 待开发 |

---

## 第十四章：最佳实践

### 14.1 性能最佳实践

| 实践 | 描述 |
|------|------|
| 使用非托管类型 | 尽量使用 struct 和非托管类型 |
| 避免装箱 | 使用泛型 API 避免装箱 |
| 复用缓冲区 | 复用 IBufferWriter 实例 |
| 批量操作 | 批量序列化减少调用开销 |
| 选择合适模式 | 根据场景选择序列化模式 |

### 14.2 设计最佳实践

| 实践 | 描述 |
|------|------|
| 保持类型简单 | 序列化类型保持简单结构 |
| 使用属性标记 | 明确标记序列化行为 |
| 版本规划 | 提前规划版本兼容策略 |
| 测试覆盖 | 充分测试序列化逻辑 |

### 14.3 安全最佳实践

| 实践 | 描述 |
|------|------|
| 输入验证 | 验证反序列化数据 |
| 大小限制 | 限制反序列化数据大小 |
| 类型白名单 | 限制可反序列化的类型 |
| 加密敏感数据 | 对敏感数据进行加密 |

---

## 第十五章：附录

### 15.1 术语表

| 术语 | 定义 |
|------|------|
| 序列化 | 将对象转换为字节流的过程 |
| 反序列化 | 将字节流还原为对象的过程 |
| 格式化器 | 负责特定类型序列化逻辑的组件 |
| 零拷贝 | 不进行数据复制的序列化方式 |
| VarInt | 变长整数编码 |
| SIMD | 单指令多数据并行处理 |

### 15.2 错误码表

| 错误码 | 描述 | 处理建议 |
|--------|------|----------|
| E001 | 类型不支持序列化 | 注册自定义格式化器 |
| E002 | 数据格式错误 | 检查数据完整性 |
| E003 | 版本不兼容 | 实现版本迁移 |
| E004 | 缓冲区溢出 | 增加缓冲区大小 |
| E005 | 循环引用检测 | 使用 CircularReference 模式 |
| E006 | 类型不匹配 | 检查类型定义 |

### 15.3 配置参数表

| 参数 | 默认值 | 描述 |
|------|--------|------|
| MaxDepth | 64 | 最大递归深度 |
| MaxStringLength | 1MB | 最大字符串长度 |
| MaxCollectionSize | 1M | 最大集合大小 |
| BufferInitialSize | 4KB | 初始缓冲区大小 |
| BufferMaxSize | 1GB | 最大缓冲区大小 |

### 15.4 参考资料

| 资料 | 描述 |
|------|------|
| MemoryPack | 高性能序列化框架参考 |
| MessagePack | 二进制序列化格式参考 |
| Protocol Buffers | Google 序列化框架参考 |
| Unity Serialization | Unity 内置序列化参考 |

---

## 文档版本历史

| 版本 | 日期 | 描述 |
|------|------|------|
| 1.0.0 | 2026-01-01 | 初始版本 |

---

*本文档由 AFramework 团队编写，版权所有。*
