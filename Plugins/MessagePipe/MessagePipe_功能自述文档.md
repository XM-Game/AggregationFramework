# MessagePipe 功能自述文档

## 框架概述

MessagePipe 是一个高性能的消息管道框架，专为 Unity 和 .NET 应用程序设计。它提供了强大的发布-订阅（Pub/Sub）机制、请求-响应模式、以及跨进程通信能力。框架采用依赖注入设计，支持与 VContainer、Zenject 等主流依赖注入容器无缝集成。

## 核心功能特性

### 发布-订阅模式

MessagePipe 提供了完整的发布-订阅消息系统，支持多种消息传递模式：

**同步消息传递**：支持同步的消息发布和订阅，适用于需要立即处理的场景。发布者可以立即将消息发送给所有订阅者，订阅者同步处理消息。

**异步消息传递**：提供基于 UniTask 的异步消息处理能力，支持异步发布和订阅。异步发布支持并行和串行两种策略，可以根据业务需求选择执行方式。

**带键的消息传递**：支持基于键的消息路由，允许使用不同类型的键（如字符串、枚举、整数等）来分类和路由消息。同一类型的消息可以通过不同的键进行区分，实现更精细的消息管理。

**缓冲消息**：提供缓冲消息机制，新订阅者可以立即接收到最后一条已发布的消息。这对于状态同步和初始化场景非常有用，确保订阅者能够获取最新的状态信息。支持同步缓冲和异步缓冲两种模式。

**重要限制**：带键的消息（Keyed Messages）不支持缓冲机制，因为难以避免未使用键的内存泄漏问题。

### 请求-响应模式

框架实现了完整的请求-响应处理机制：

**同步请求处理**：支持同步的请求-响应模式，请求者发送请求后立即等待响应。可以注册多个处理器，支持单响应和多响应两种模式。

**异步请求处理**：提供异步请求-响应能力，支持基于 UniTask 的异步处理。异步请求可以设置取消令牌，支持取消操作。异步多处理器支持延迟异步枚举（InvokeAllLazyAsync），可以按需异步处理响应。异步多处理器调用支持并行和串行两种策略，可以配置执行方式。

**远程请求异常**：提供 RemoteRequestException 异常类型，用于标识远程请求处理过程中的错误。

**远程请求处理**：支持跨进程的远程请求-响应，通过进程间通信机制实现分布式请求处理。

**多处理器支持**：对于同一请求类型，可以注册多个处理器，框架支持调用所有处理器并收集所有响应。支持立即收集所有响应（InvokeAll）和延迟枚举响应（InvokeAllLazy）两种模式，延迟枚举模式可以按需逐个处理响应，节省内存。

### 过滤器系统

MessagePipe 提供了强大的过滤器机制，可以在消息处理过程中插入自定义逻辑：

**消息处理器过滤器**：支持在消息处理前后执行自定义逻辑，如日志记录、性能监控、权限验证等。过滤器可以按顺序执行，支持全局过滤器和局部过滤器。

**异步消息过滤器**：专门为异步消息处理设计的过滤器，支持异步操作和取消令牌。

**请求处理器过滤器**：针对请求-响应模式的过滤器，可以在请求处理前后执行逻辑，如参数验证、结果转换等。

**过滤器排序**：所有过滤器支持通过 Order 属性控制执行顺序，确保过滤器按照预期顺序执行。

**属性标记过滤器**：支持通过特性（Attribute）在处理器类上标记过滤器，实现声明式的过滤器配置。框架会自动从处理器类的特性中提取过滤器信息，并按照 Order 属性排序应用。

**过滤器工厂**：提供过滤器工厂机制，自动将全局过滤器、属性过滤器和局部过滤器组合应用到消息处理器上。过滤器按照 Order 降序排列，确保执行顺序正确。

**过滤器缓存**：属性过滤器定义会被缓存，避免重复反射操作，提高性能。

### 分布式发布订阅

框架提供了分布式发布订阅能力，支持跨应用、跨进程的消息传递：

**内存分布式发布订阅**：提供基于内存的分布式发布订阅实现，适用于同一进程内的不同作用域之间的消息传递。

**可扩展的分布式接口**：定义了标准的分布式发布订阅接口，可以轻松扩展实现基于网络、消息队列等不同传输方式的分布式通信。

### 进程间通信

MessagePipe.Interprocess 模块提供了强大的跨进程通信能力：

**TCP 通信**：支持基于 TCP 协议的进程间通信，适用于需要可靠传输的场景。支持服务器-客户端模式，可以建立稳定的连接进行消息传递。

**UDP 通信**：提供基于 UDP 协议的进程间通信，适用于对实时性要求高、允许少量丢包的场景。支持广播和组播功能。

**命名管道通信**：支持 Windows 命名管道通信，适用于同一台机器上的进程间通信，提供高效的本地进程通信能力。

**消息序列化**：所有进程间通信都使用 MessagePack 进行消息序列化，确保高效的数据传输和跨平台兼容性。

**远程请求支持**：进程间通信模块支持远程请求-响应模式，可以在不同进程间进行请求调用。支持异步请求处理器注册表，用于在远程端查找和调用对应的请求处理器。

### 依赖注入集成

框架与主流依赖注入容器深度集成：

**VContainer 集成**：提供完整的 VContainer 集成支持，可以通过 VContainer 的容器构建器注册 MessagePipe 服务。支持自动注册消息代理、请求处理器等组件。

**Zenject 集成**：提供 Zenject 集成模块，支持通过 Zenject 的容器绑定 MessagePipe 服务。自动处理生命周期管理，确保与 Zenject 的作用域机制协调工作。

**Microsoft.Extensions.DependencyInjection 集成**：支持标准的 .NET 依赖注入容器，可以在非 Unity 环境中使用。

**Unity 内置容器支持**：提供 BuiltinContainerBuilder，这是一个轻量级的依赖注入容器实现，无需依赖外部 DI 框架即可使用 MessagePipe。支持构造函数注入、单例和瞬态生命周期，适合简单的 Unity 项目或作为学习示例。

**自动注册功能**：支持自动扫描和注册消息处理器、请求处理器等组件，减少手动配置工作。可以配置搜索的程序集和类型范围，精确控制自动注册的行为。自动注册会智能排除系统程序集和第三方库，只扫描用户代码。

**类型收集器**：提供类型收集器工具，可以从当前应用程序域或指定程序集中收集类型，支持过滤已知的系统程序集，提高自动注册的效率。

**忽略自动注册**：提供 IgnoreAutoRegistration 特性，可以标记特定的类，使其在自动注册过程中被忽略，提供更精细的控制。

**生命周期管理**：支持单例（Singleton）、作用域（Scoped）和瞬态（Transient）三种生命周期模式，可以根据需求选择合适的生命周期。

### 作用域支持

框架支持多种作用域模式：

**单例作用域**：消息代理和订阅者在整个应用生命周期内保持单例，适用于全局事件和系统级消息。

**作用域模式**：支持基于依赖注入容器作用域的消息代理，可以在不同的作用域内创建独立的消息通道。

**瞬态模式**：支持每次请求都创建新的消息代理实例，适用于需要完全隔离的场景。

### 诊断和调试工具

框架提供了丰富的诊断和调试功能：

**诊断信息窗口**：Unity 编辑器集成了诊断信息窗口（Window/MessagePipe Diagnostics），可以实时查看消息订阅情况、处理器注册状态、消息传递统计等信息。窗口支持树形视图展示，可以按消息类型分组查看订阅详情。

**堆栈跟踪捕获**：支持启用堆栈跟踪捕获功能，可以追踪消息发布和订阅的调用路径，便于调试和问题定位。每个订阅都会记录其创建时的堆栈跟踪信息，包括时间戳和调用位置。

**堆栈跟踪分组**：诊断信息可以按调用者进行分组查看，方便识别哪些代码位置创建了最多的订阅。支持按时间升序或降序排序。

**堆栈跟踪清理**：自动清理和格式化异步堆栈跟踪信息，移除框架内部调用，突出显示用户代码的调用路径，提高可读性。

**自动重载功能**：诊断窗口支持自动重载模式，可以定期刷新视图，实时反映订阅状态的变化。

**堆栈跟踪折叠**：支持折叠重复的堆栈跟踪信息，减少视觉干扰，专注于重要的调用路径。

**订阅统计**：框架内部维护订阅统计信息，可以查看每个消息类型的订阅者数量、消息发布次数等统计数据。支持实时查看当前活跃订阅总数。

**性能监控**：可以监控消息处理的性能指标，帮助识别性能瓶颈。框架内部使用高效的数据结构（如 FreeList、FastQueue）优化性能。

### 全局访问和事件工厂

**GlobalMessagePipe**：提供全局静态访问点，允许在不使用依赖注入容器的情况下访问消息管道。支持获取所有类型的发布者、订阅者、请求处理器和缓冲消息代理。需要在初始化时设置服务提供者。

**EventFactory**：提供事件工厂机制，可以创建独立的事件实例，不依赖依赖注入容器。支持创建普通事件、异步事件、缓冲事件和缓冲异步事件。创建的事件包含可释放的发布者和订阅者，便于管理生命周期。

### 订阅生命周期管理

**DisposableBag**：提供订阅生命周期管理工具，用于批量管理多个订阅的释放。支持创建一次性释放多个订阅的容器，提供构建器模式方便添加订阅，支持单次赋值和取消令牌的封装。这对于管理组件生命周期内的所有订阅非常有用。

**单次赋值可释放对象**：提供 SingleAssignmentDisposable，确保一个可释放对象只能被赋值一次，如果对象已被释放则立即释放新赋值的对象，防止资源泄漏。

**取消令牌封装**：提供 CancellationTokenDisposable，将 CancellationTokenSource 封装为可释放对象，释放时自动取消令牌，便于统一管理。

### 扩展和集成能力

**Observable 集成**：支持将订阅者转换为 IObservable，可以与响应式编程框架（如 UniRx、R3）集成。支持普通订阅者、缓冲订阅者和带键订阅者的转换。

**AsyncEnumerable 支持**：支持将异步订阅者转换为异步枚举器（IUniTaskAsyncEnumerable），可以使用异步流处理消息。支持普通异步订阅者、缓冲异步订阅者和带键异步订阅者的转换。

**FirstAsync 扩展**：提供 FirstAsync 扩展方法，可以等待接收第一条符合条件的消息，适用于一次性事件监听场景。支持同步订阅者、异步订阅者、缓冲订阅者以及带键订阅者。支持取消令牌和谓词过滤。

**谓词过滤**：支持在订阅时使用谓词函数进行消息过滤，只处理符合条件的消息。可以与其他过滤器组合使用。谓词过滤器会自动设置最低优先级（int.MinValue），确保在所有其他过滤器之前执行。

**匿名处理器支持**：支持直接使用 Action 和 Func 委托作为消息处理器，无需实现接口。框架内部会自动包装为对应的处理器实现，简化使用。

**分布式订阅扩展**：提供分布式订阅的便捷扩展方法，支持使用 Action 和 Func 委托直接订阅分布式消息，支持谓词过滤和过滤器组合。

### 配置选项

框架提供了丰富的配置选项：

**异步发布策略**：可以配置异步消息的发布策略，支持并行执行和串行执行两种模式。

**订阅处理策略**：可以配置在已释放的订阅者上调用 Subscribe 时的处理策略，支持忽略或抛出异常。

**实例生命周期**：可以全局配置消息代理和请求处理器的默认生命周期。

**自动注册配置**：可以配置自动注册的搜索程序集和类型，控制自动注册的范围。

**全局过滤器配置**：支持配置全局过滤器，所有消息处理都会自动应用这些过滤器。支持开放泛型过滤器，可以一次注册应用到所有消息类型。

**过滤器优先级**：过滤器通过 Order 属性控制执行顺序，数值越大优先级越高。谓词过滤器自动设置为最低优先级，确保先进行消息过滤。

## 适用场景

MessagePipe 适用于以下场景：

- **游戏事件系统**：实现游戏内的事件通知和状态同步
- **模块间通信**：解耦不同模块之间的依赖关系，实现松耦合的架构
- **UI 更新通知**：实现数据变化到 UI 的自动更新，缓冲消息特别适合状态同步
- **分布式系统**：支持多进程、多应用的分布式消息传递
- **请求路由**：实现请求-响应模式的服务调用，支持多处理器聚合响应
- **中间件功能**：通过过滤器实现日志、监控、验证等横切关注点
- **响应式编程**：通过 Observable 和 AsyncEnumerable 集成，实现响应式数据流
- **一次性事件监听**：使用 FirstAsync 等待特定条件的消息

## 技术特点

- **高性能**：采用高效的数据结构和算法，最小化消息传递的开销。内部使用 FreeList 管理订阅者列表，FastQueue 处理消息队列，PoolStack 进行对象池化，确保最佳性能表现。

- **类型安全**：基于泛型设计，提供编译时类型检查，避免运行时类型错误。

- **内存友好**：合理管理订阅生命周期，使用 FreeList 重用索引，避免频繁的内存分配和释放，有效防止内存泄漏。

- **线程安全**：支持多线程环境下的消息发布和订阅，使用锁机制和原子操作确保线程安全。

- **易于使用**：提供简洁的 API 和丰富的扩展方法，支持多种使用模式，从简单的全局访问到复杂的依赖注入集成。

- **可扩展性**：支持自定义过滤器、自定义传输方式等扩展，框架设计灵活，易于定制和扩展。

- **Unity 优化**：针对 Unity 平台进行了特殊优化，支持 IL2CPP 代码剥离，使用 Preserve 特性确保关键代码不被优化掉。

## 总结

MessagePipe 是一个功能完整、性能优异的消息管道框架，为 Unity 和 .NET 应用提供了强大的消息传递能力。通过发布-订阅、请求-响应、过滤器、分布式通信等核心功能，以及完善的依赖注入集成和诊断工具，它能够满足从简单事件通知到复杂分布式系统的各种需求。框架的设计注重性能、类型安全和易用性，是构建解耦、可维护应用程序的理想选择。

